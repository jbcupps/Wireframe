{% extends "base.html" %}
{% block title %}4D Manifold Explorer - Visualization{% endblock %}
{% block head_extra %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="{{ url_for('static', filename='js/plotly-defaults.js') }}"></script>
<style>
    /* Enhanced Visualization Specific Styles */
    .main-content {
        display: flex;
        flex-direction: row;
        gap: 20px;
        width: 100%;
        margin: 80px auto 0;
        padding: 0 20px;
        box-sizing: border-box;
        min-height: calc(100vh - 100px);
    }
    
    .visualization-panel {
        flex: 3;
        background: var(--surface-elevated);
        border-radius: var(--border-radius-elegant);
        box-shadow: var(--shadow-elegant);
        overflow: hidden;
        position: relative;
        min-height: 600px;
        height: calc(100vh - 200px);
        max-height: 800px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
        .plot-container {        width: 100%;        height: calc(100% - 140px);        background: radial-gradient(ellipse at center, rgba(15, 20, 25, 0.95), rgba(15, 20, 25, 1));        border-radius: 12px;        position: relative;        overflow: hidden;        margin-bottom: 10px;    }
    
    .controls-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 15px;
        min-width: 320px;
        max-width: 380px;
        height: fit-content;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--primary) var(--surface);
    }
    
    .controls-panel::-webkit-scrollbar {
        width: 6px;
    }
    
    .controls-panel::-webkit-scrollbar-track {
        background: var(--surface);
        border-radius: 3px;
    }
    
    .controls-panel::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 3px;
    }
    
    .control-card {
        background: var(--surface-elevated);
        border-radius: var(--border-radius-elegant);
        padding: 20px;
        box-shadow: var(--shadow-elegant);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: var(--transition-smooth);
    }
    
    .control-card:hover {
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
    }
    
    .card-header {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 12px;
    }
    
    .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .sub-skb-title {
        font-size: 1.05rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sub-skb-title.skb1 { border-left: 3px solid var(--skb1-color); padding-left: 12px; }
    .sub-skb-title.skb2 { border-left: 3px solid var(--skb2-color); padding-left: 12px; }
    .sub-skb-title.skb3 { border-left: 3px solid var(--skb3-color); padding-left: 12px; }
    
    /* Enhanced Slider Styles */
    .slider-container {
        margin-bottom: 18px;
        position: relative;
    }
    
    .slider-container label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .value-display {
        background: rgba(99, 102, 241, 0.15);
        color: var(--primary);
        padding: 2px 8px;
        border-radius: 6px;
        font-weight: 600;
        min-width: 50px;
        text-align: center;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        font-size: 0.85rem;
        border: 1px solid rgba(99, 102, 241, 0.3);
        transition: var(--transition-smooth);
    }
    
    .value-display.highlight {
        background: rgba(99, 102, 241, 0.3);
        color: #8b5cf6;
        box-shadow: 0 0 12px rgba(99, 102, 241, 0.4);
        transform: scale(1.05);
    }
    
    /* Enhanced Toggle Styles */
    .toggle-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 20px 0;
        padding: 12px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .toggle-label {
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.9rem;
        -webkit-user-select: none;
        user-select: none;
    }
    
    /* Enhanced Button Styles */
    .button-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    
    .button-group button {
        flex: 1;
        min-width: 120px;
        padding: 12px 16px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        transition: var(--transition-bounce);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        position: relative;
        overflow: hidden;
    }
    
    #reset-btn {
        background: linear-gradient(135deg, #64748b, #475569);
        color: white;
        box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
    }
    
    #reset-btn:hover {
        background: linear-gradient(135deg, #475569, #334155);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(100, 116, 139, 0.4);
    }
    
    #animate-btn {
        background: var(--primary-gradient);
        color: white;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    
    #animate-btn:hover {
        background: linear-gradient(135deg, #8b5cf6, #a855f7);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }
    
    #animate-btn.active {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    
    #animate-btn.active:hover {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }
    
    /* Properties Panel Enhancements */    .properties-panel {        position: absolute;        bottom: 0;        left: 0;        right: 0;        background: rgba(45, 55, 72, 0.9);        -webkit-backdrop-filter: blur(10px);        backdrop-filter: blur(10px);        border-top: 1px solid rgba(255, 255, 255, 0.1);        padding: 6px 20px;        border-radius: 0 0 var(--border-radius-elegant) var(--border-radius-elegant);        z-index: 100;        max-height: 80px;        overflow-y: auto;        opacity: 0.85;        transition: opacity 0.3s ease;    }        .properties-panel:hover {        opacity: 1;    }
    
    .properties-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
        .property-item {        display: flex;        justify-content: space-between;        align-items: center;        margin-bottom: 3px;        font-size: 0.75rem;        position: relative;        line-height: 1.2;    }
    
    .property-name {
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .property-value {
        color: var(--primary);
        font-weight: 600;
        font-family: 'JetBrains Mono', 'Courier New', monospace;
        transition: var(--transition-smooth);
    }
    
    .property-value.highlight {
        color: #8b5cf6;
        text-shadow: 0 0 8px rgba(139, 92, 246, 0.5);
        transform: scale(1.05);
    }
    
    /* Compatibility Status Styling */
    .compatible-status { color: #4ade80; }
    .incompatible-status { color: #f87171; }
    .neutral-status { color: #fbbf24; }
    
    /* Help Modal Enhancements */
    .help-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 56px;
        height: 56px;
        background: var(--primary-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        transition: var(--transition-bounce);
        z-index: 1000;
        border: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    .help-button:hover {
        transform: scale(1.1);
        box-shadow: 0 8px 30px rgba(99, 102, 241, 0.6);
    }
    
    .help-button i {
        color: white;
        font-size: 1.4rem;
    }
    
    .help-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
        -webkit-backdrop-filter: blur(5px);
        backdrop-filter: blur(5px);
    }
    
    .help-content {
        background: var(--surface-elevated);
        border-radius: var(--border-radius-elegant);
        padding: 30px;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        margin: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-elegant);
    }
    
    .help-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .help-header h2 {
        margin: 0;
        color: var(--text-primary);
        font-size: 1.5rem;
    }
    
    .close-help {
        font-size: 2rem;
        color: var(--text-secondary);
        cursor: pointer;
        line-height: 1;
        transition: color 0.3s ease;
    }
    
    .close-help:hover {
        color: var(--primary);
    }
    
    .help-section {
        margin-bottom: 25px;
    }
    
    .help-subtitle {
        color: var(--primary);
        font-size: 1.2rem;
        margin-bottom: 12px;
        font-weight: 600;
    }
    
    .help-section p {
        line-height: 1.6;
        color: var(--text-secondary);
        margin-bottom: 12px;
    }
    
    .help-section ul {
        margin-left: 20px;
        color: var(--text-secondary);
    }
    
    .help-section li {
        margin-bottom: 8px;
        line-height: 1.5;
    }
    
    .help-section a {
        color: var(--primary);
        text-decoration: none;
        transition: color 0.3s ease;
    }
    
    .help-section a:hover {
        color: #8b5cf6;
        text-decoration: underline;
    }
    
        /* Research Links Enhancement */    .research-links {        text-align: center;        margin: 20px 0;        padding: 15px;        background: rgba(255, 255, 255, 0.02);        border-radius: 12px;        border: 1px solid rgba(255, 255, 255, 0.05);    }        /* Fix for text overlay issues */    #plot {        height: 100% !important;        position: relative;        z-index: 1;    }        .js-plotly-plot {        height: 100% !important;    }        /* Minimize properties panel intrusion */    .properties-panel {        font-size: 0.7rem !important;        padding: 4px 15px !important;        max-height: 60px !important;        background: rgba(45, 55, 72, 0.8) !important;    }
    
    .research-links p {
        margin: 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .research-links a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.3s ease;
    }
    
    .research-links a:hover {
        color: #8b5cf6;
        text-decoration: underline;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
        .main-content {
            flex-direction: column;
            gap: 15px;
        }
        
        .controls-panel {
            max-width: none;
            min-width: auto;
            max-height: none;
            overflow-y: visible;
        }
        
        .visualization-panel {
            height: 500px;
        }
    }
    
    @media (max-width: 768px) {
        .main-content {
            margin: 60px auto 0;
            padding: 0 10px;
        }
        
        .control-card {
            padding: 15px;
        }
        
        .button-group {
            flex-direction: column;
        }
        
        .button-group button {
            min-width: auto;
        }
        
        .help-content {
            padding: 20px;
            margin: 10px;
        }
        
        .properties-panel {
            padding: 8px 15px;
        }
        
        .property-item {
            font-size: 0.75rem;
        }
    }
    
    /* Loading and Error States */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(15, 20, 25, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        border-radius: 12px;
    }
    
    .loading-spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(99, 102, 241, 0.3);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #fca5a5;
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .error-message i {
        color: #ef4444;
    }
</style>
{% endblock %}

{% block content %}
    <div class="main-content">
        <div class="container">
            <!-- Main Page Header -->
            <header>
                <h1>Spacetime Klein Bottle 4D Manifold Explorer</h1>
                <div class="subtitle">Interactive visualization and exploration of 4D manifold topological structures</div>
            </header>
    
            <div class="research-links">
                <p>Research: <a href="https://figshare.com/articles/preprint/A_Categorical_Framework_for_Topological_Features_of_Spacetime_Klein_Bottles_in_Particle_Physics/28466279?file=52550969" target="_blank" rel="noopener">Categorical Framework</a> | <a href="https://figshare.com/articles/preprint/4D_Spacetime_Klein_Bottles_as_Fundamental_Particle_Models_pdf/28466276?file=52550963" target="_blank" rel="noopener">SKB Particle Models</a></p>
            </div>
    
            <div class="main-content">
                <!-- Visualization panel with the plot and properties -->
                <div class="visualization-panel">
                    <div id="plot" class="plot-container">
                        <div id="loading-overlay" class="loading-overlay" style="display: none;">
                            <div class="loading-spinner"></div>
                        </div>
                    </div>
                    
                    <!-- Topological properties panel -->
                    <div class="properties-panel">
                        <div class="properties-title">Topological Properties</div>
                        <div class="property-item">
                            <span class="property-name">Euler Characteristic:</span>
                            <span class="property-value" id="euler-characteristic">0</span>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Stiefel-Whitney Classes:</span>
                            <span class="property-value" id="stiefel-whitney">w₁ = 1, w₂ = 0</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Stiefel-Whitney classes are cohomology classes that characterize the twisting of the tangent bundle. w₁ indicates orientability (0 for orientable, 1 for non-orientable).</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Intersection Form:</span>
                            <span class="property-value" id="intersection-form">Q = { }</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">The intersection form is a symmetric bilinear form on the middle-dimensional homology. It describes how 2-cycles intersect in a 4-manifold and relates to particle interactions.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Kirby-Siebenmann Invariant:</span>
                            <span class="property-value" id="kirby-siebenmann">0</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">The Kirby-Siebenmann invariant is an obstruction to smoothing a 4-manifold. When non-zero, it indicates exotic smooth structures that may relate to quantum-gravitational effects in the SKB model.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">CTC Stability:</span>
                            <span class="property-value" id="ctc-stability">Stable</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Indicates whether the configuration allows for stable closed timelike curves (CTCs). Stability depends on the complementary nature of time twist parameters across sub-SKBs.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Compatibility:</span>
                            <span class="property-value" id="compatibility-status">Compatible</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Indicates whether the current SKB configuration is compatible with stable hadron formation based on topological constraints and CTC stability.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Genus:</span>
                            <span class="property-value" id="genus">1</span>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Homology Groups:</span>
                            <span class="property-value" id="homology-groups">H₁ = Z ⊕ Z₂</span>
                        </div>
                    </div>
                </div>
                
                <!-- Controls panel -->
                <div class="controls-panel">
                    <!-- Global controls card -->
                    <div class="control-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-globe"></i>
                                Global Controls
                            </h3>
                        </div>
                        
                        <div class="toggle-container">
                            <span class="toggle-label">Individual SKBs</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="merge-toggle" onchange="updateVisualization()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Merged SKB</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Toggle between individual sub-SKBs (representing quark-like components) and merged stable SKB (representing a composite particle). In categorical theory, this represents a colimit of the sub-objects.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="time">Time Evolution <span id="time-value" class="value-display">0</span></label>
                            <input type="range" id="time" min="0" max="6.28" value="0" step="0.1" class="slider" oninput="updateSliderValue('time'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the time parameter, simulating evolution through closed timelike curves (CTCs). In 4D SKB theory, this represents how particles evolve through spacetime while maintaining their topological identity.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop-factor">Global Loop Factor <span id="loop-factor-value" class="value-display">1</span></label>
                            <input type="range" id="loop-factor" min="1" max="5" value="1" step="1" class="slider" oninput="updateSliderValue('loop-factor'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in the merged structure. Higher values create more complex structures. In SKB theory, loop factors correspond to energy levels and may relate to particle mass through topological complexity.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-SKB 1 Controls -->
                    <div class="control-card">
                        <div class="sub-skb-title skb1">
                            <span class="color-indicator color-skb1"></span>Sub-SKB 1
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">First quark-like component in the categorical SKB framework. In particle physics analogy, this might represent an "up" quark with specific topological features that contribute to its properties.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop1">Loop Factor <span id="loop1-value" class="value-display">1</span></label>
                            <input type="range" id="loop1" min="1" max="5" value="1" step="1" class="slider" oninput="updateSliderValue('loop1'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in this sub-SKB. In the categorical framework, this is related to the first homology group generators and may correspond to a particle's internal energy configurations.</span>
                            </div>
                        </div>
                        
                        <div class="sub-skb-section">
                            <div class="twist-controls">
                                <div class="twist-axis">
                                    <label for="t1x">X-Twist <span id="t1x-value" class="value-display">0</span></label>
                                    <input type="range" id="t1x" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t1x'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">X-axis twist parameter for sub-SKB 1. In the 4D model, this relates to spatial twisting in the first dimension and may correspond to specific quantum numbers.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t1y">Y-Twist <span id="t1y-value" class="value-display">0</span></label>
                                    <input type="range" id="t1y" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t1y'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Y-axis twist parameter for sub-SKB 1. This represents torsion in the second spatial dimension and may relate to particle spin properties.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t1z">Z-Twist <span id="t1z-value" class="value-display">0</span></label>
                                    <input type="range" id="t1z" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t1z'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Z-axis twist parameter for sub-SKB 1. Controls vertical torsion and may relate to charge properties in the SKB particle model.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t1t">Time-Twist <span id="t1t-value" class="value-display">0</span></label>
                                    <input type="range" id="t1t" min="-1" max="1" value="0" step="0.1" class="slider" oninput="updateSliderValue('t1t'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Controls the time-like twist parameter for Sub-SKB 1, affecting the formation of closed timelike curves (CTCs). Balancing time twists across Sub-SKBs is essential for CTC stability.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-SKB 2 Controls -->
                    <div class="control-card">
                        <div class="sub-skb-title skb2">
                            <span class="color-indicator color-skb2"></span>Sub-SKB 2
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Second quark-like component in the SKB framework. In particle physics analogy, this might represent another "up" quark with complementary topological features to the first.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop2">Loop Factor <span id="loop2-value" class="value-display">1</span></label>
                            <input type="range" id="loop2" min="1" max="5" value="1" step="1" class="slider" oninput="updateSliderValue('loop2'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in the second sub-SKB. In the categorical model, different loop configurations may represent different energy states or quantum excitations.</span>
                            </div>
                        </div>
                        
                        <div class="sub-skb-section">
                            <div class="twist-controls">
                                <div class="twist-axis">
                                    <label for="t2x">X-Twist <span id="t2x-value" class="value-display">0</span></label>
                                    <input type="range" id="t2x" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t2x'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">X-axis twist for the second sub-SKB. Combinations of twists between different sub-SKBs may represent particle interactions in the categorical model.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t2y">Y-Twist <span id="t2y-value" class="value-display">0</span></label>
                                    <input type="range" id="t2y" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t2y'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Y-axis twist for sub-SKB 2. The relative Y-twist values between sub-SKBs may correspond to binding energies in the composite structure.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t2z">Z-Twist <span id="t2z-value" class="value-display">0</span></label>
                                    <input type="range" id="t2z" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t2z'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Z-axis twist for sub-SKB 2. In the 4D spacetime model, this represents how this component interacts with the vertical dimension and may relate to strong force carrier interactions.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t2t">Time-Twist <span id="t2t-value" class="value-display">0</span></label>
                                    <input type="range" id="t2t" min="-1" max="1" value="0" step="0.1" class="slider" oninput="updateSliderValue('t2t'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Controls the time-like twist parameter for Sub-SKB 2, affecting the formation of closed timelike curves (CTCs). Balancing time twists across Sub-SKBs is essential for CTC stability.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-SKB 3 Controls -->
                    <div class="control-card">
                        <div class="sub-skb-title skb3">
                            <span class="color-indicator color-skb3"></span>Sub-SKB 3
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Third quark-like component in the SKB framework. In particle physics analogy, this might represent a "down" quark with distinct topological features that contribute to the composite particle's properties.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop3">Loop Factor <span id="loop3-value" class="value-display">1</span></label>
                            <input type="range" id="loop3" min="1" max="5" value="1" step="1" class="slider" oninput="updateSliderValue('loop3'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in the third sub-SKB. In topological terms, this may represent how many times this component wraps around itself, affecting its contribution to the overall particle mass.</span>
                            </div>
                        </div>
                        
                        <div class="sub-skb-section">
                            <div class="twist-controls">
                                <div class="twist-axis">
                                    <label for="t3x">X-Twist <span id="t3x-value" class="value-display">0</span></label>
                                    <input type="range" id="t3x" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t3x'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">X-axis twist for sub-SKB 3. In the categorical framework, this corresponds to a specific morphism that alters the topology in ways that may relate to flavor quantum numbers.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t3y">Y-Twist <span id="t3y-value" class="value-display">0</span></label>
                                    <input type="range" id="t3y" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t3y'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Y-axis twist for sub-SKB 3. Different twist configurations across all sub-SKBs may correspond to different particle states or resonances in the SKB model.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t3z">Z-Twist <span id="t3z-value" class="value-display">0</span></label>
                                    <input type="range" id="t3z" min="-5" max="5" value="0" step="1" class="slider" oninput="updateSliderValue('t3z'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Z-axis twist for sub-SKB 3. In the spacetime model with closed timelike curves, this parameter may influence how this component interacts with the time dimension.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t3t">Time-Twist <span id="t3t-value" class="value-display">0</span></label>
                                    <input type="range" id="t3t" min="-1" max="1" value="0" step="0.1" class="slider" oninput="updateSliderValue('t3t'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Controls the time-like twist parameter for Sub-SKB 3, affecting the formation of closed timelike curves (CTCs). Balancing time twists across Sub-SKBs is essential for CTC stability.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="button-group">
                        <button id="reset-btn" onclick="resetControls()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button id="animate-btn" onclick="toggleAnimation()">
                            <i class="fas fa-play" id="animate-icon"></i> <span id="animate-text">Animate</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Button and Modal -->
    <div class="help-button" onclick="toggleHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>Interactive Guide</h2>
                <span class="close-help" onclick="toggleHelpModal()">&times;</span>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">What is a Spacetime Klein Bottle?</h3>
                <p>A Spacetime Klein Bottle (SKB) is a non-orientable topological surface with no boundary embedded in 4D spacetime with closed timelike curves. In this model, fundamental particles are represented as SKBs, with intrinsic properties like mass and charge emerging from their topology.</p>
                <p>This visualization is based on research papers exploring a novel hypothesis where quarks and baryons can be modeled using topological structures:</p>
                <ul>
                    <li><a href="https://figshare.com/articles/preprint/A_Categorical_Framework_for_Topological_Features_of_Spacetime_Klein_Bottles_in_Particle_Physics/28466279?file=52550969" target="_blank" rel="noopener">A Categorical Framework for Topological Features of Spacetime Klein Bottles in Particle Physics</a></li>
                    <li><a href="https://figshare.com/articles/preprint/4D_Spacetime_Klein_Bottles_as_Fundamental_Particle_Models_pdf/28466276?file=52550963" target="_blank" rel="noopener">4D Spacetime Klein Bottles as Fundamental Particle Models</a></li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Basic Controls</h3>
                <ul>
                    <li><strong>Merged Mode:</strong> Toggle between viewing individual sub-SKBs or a merged stable SKB.</li>
                    <li><strong>Time Evolution:</strong> Controls the time parameter, changing the shape dynamically.</li>
                    <li><strong>Loop Factor:</strong> Adjusts the number of loops in the structure.</li>
                    <li><strong>Twist Controls:</strong> Modify the twist parameters along the X, Y, and Z axes.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Navigation Tips</h3>
                <p>The 3D visualization supports the following interactions:</p>
                <ul>
                    <li><strong>Rotate:</strong> Click and drag to rotate the view.</li>
                    <li><strong>Zoom:</strong> Use the scroll wheel or pinch gesture to zoom in/out.</li>
                    <li><strong>Pan:</strong> Right-click and drag (or two-finger drag) to pan the view.</li>
                    <li><strong>Reset View:</strong> Double-click to reset the camera position.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3>About Topological Properties</h3>
                <p>The SKB visualizer calculates and displays several key topological invariants that characterize the 4D manifold structure, which we represent through wireframe visualizations:</p>
                <ul>
                    <li><strong>Euler Characteristic:</strong> A topological invariant, calculated as V - E + F (vertices - edges + faces). For Klein bottles, this is always 0.</li>
                    <li><strong>Stiefel-Whitney Classes:</strong> Cohomology classes that characterize the twisting of the tangent bundle. The first class (w₁) indicates orientability, while the second class (w₂) is related to the possibility of having a spin structure.</li>
                    <li><strong>Intersection Form:</strong> A bilinear form on the middle-dimensional homology that describes how 2-cycles intersect.</li>
                    <li><strong>Kirby-Siebenmann Invariant:</strong> An obstruction to smoothing a 4-manifold. When non-zero, it indicates exotic smooth structures that may relate to quantum-gravitational effects in the SKB model.</li>
                    <li><strong>Genus:</strong> Roughly corresponds to the number of "holes" in the surface. In SKB theory, this relates to particle generation.</li>
                    <li><strong>Homology Groups:</strong> Algebraic structures that capture the essential topological features. For Klein bottles, H₁ = Z ⊕ Z₂, representing its non-orientability and loop structure.</li>
                    <li><strong>CTC Stability:</strong> Indicates whether the configuration allows for stable closed timelike curves (CTCs). Stability depends on the complementary nature of time twist parameters across sub-SKBs.</li>
                    <li><strong>Compatibility:</strong> Indicates whether the current SKB configuration is compatible with stable hadron formation based on topological constraints and CTC stability.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3>Topological Compatibility in the SKB Model</h3>
                <p>The Spacetime Klein Bottle model suggests that stable hadrons form when sub-SKBs combine with compatible topological properties:</p>
                <ul>
                    <li><strong>Orientability:</strong> Stable hadrons tend to form from configurations where the overall 4-manifold is orientable (w₁ = 0).</li>
                    <li><strong>Intersection Form:</strong> The intersection form must be non-trivial, indicating interaction between the sub-components.</li>
                    <li><strong>Kirby-Siebenmann Invariant:</strong> Stable configurations typically have ks = 0, corresponding to smooth structures.</li>
                    <li><strong>Twist Parameters:</strong> The combined twist parameters determine the overall topological structure and compatibility.</li>
                </ul>
                <p>Experiment with different configurations to discover compatible combinations!</p>
            </div>
            
            <div class="help-section">
                <h3>Physical Interpretation</h3>
                <p>In the SKB model of fundamental particles:</p>
                <ul>
                    <li><strong>Sub-SKBs:</strong> Represent quark-like components with distinct topological features</li>
                    <li><strong>Twist Parameters:</strong> May correspond to quantum numbers like charge, spin, or color</li>
                    <li><strong>Loop Factors:</strong> Potentially relate to energy levels and mass</li>
                    <li><strong>Merged SKB:</strong> Represents a composite particle (like a baryon) formed by combining sub-SKBs</li>
                    <li><strong>Time Evolution:</strong> Visualizes how particles evolve through closed timelike curves while maintaining their identity</li>
                </ul>
                <p>This visualization tool allows exploration of how different topological configurations might correspond to different particle states and properties.</p>
            </div>
        </div>
    </div>
    
{% endblock %}

{% block scripts %}
    <script>
        // Enhanced Animation System with Pre-recorded Loops
        let animationId = null;
        let isAnimating = false;
        let animationFrameCache = new Map();
        let smoothAnimationEnabled = true;
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE = 100; // Minimum time between updates in ms
        
        // Pre-computed animation frames for smooth playback
        const precomputedFrames = [];
        let frameIndex = 0;
        const totalFrames = 63; // For smooth 2π animation
        
        // Enhanced function to update slider value display
        function updateSliderValue(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + '-value');
            if (!slider || !display) return;
            
            let value = slider.value;
            
            // Format display value
            if (id.includes('t') && !id.includes('time')) {
                value = parseFloat(value).toFixed(1);
            } else if (id === 'time') {
                value = parseFloat(value).toFixed(2);
            } else {
                value = parseInt(value);
            }
            
            display.textContent = value;
            
            // Enhanced highlight animation
            display.classList.remove('highlight');
            void display.offsetWidth; // Trigger reflow
            display.classList.add('highlight');
            
            // Update CSS custom property for slider progress
            const percentage = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.setProperty('--slider-progress', `${percentage}%`);
            
            // Update topological properties
            updateTopologicalProperties();
        }
        
        // Enhanced visualization update with throttling and error handling
        function updateVisualization() {
            const now = Date.now();
            if (now - lastUpdateTime < UPDATE_THROTTLE && !isAnimating) {
                return;
            }
            lastUpdateTime = now;
            
            console.log("Updating visualization...");
            
            // Show loading overlay
            const loadingOverlay = document.getElementById('loading-overlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }
            
            // Clear any existing error messages
            const existingErrors = document.querySelectorAll('.error-message');
            existingErrors.forEach(error => error.remove());
            
            try {
                // Get parameters from controls
                const params = getVisualizationParameters();
                
                console.log("Fetching visualization with params:", params);
                
                fetch('/get_visualization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(params)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    console.log("Visualization data received:", data);
                    
                    try {
                        renderVisualization(data, params);
                    } catch (renderError) {
                        console.error("Error rendering visualization:", renderError);
                        showErrorMessage("Failed to render visualization: " + renderError.message);
                    }
                })
                .catch(error => {
                    console.error("Error fetching visualization:", error);
                    showErrorMessage("Failed to load visualization: " + error.message);
                })
                .finally(() => {
                    // Hide loading overlay
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                });
                
            } catch (error) {
                console.error("Error in updateVisualization:", error);
                showErrorMessage("Visualization error: " + error.message);
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        }
        
        // Extract parameters function for better organization
        function getVisualizationParameters() {
            return {
                t: parseFloat(document.getElementById('time').value),
                loop_factor: parseInt(document.getElementById('loop-factor').value),
                loop1: parseInt(document.getElementById('loop1').value),
                loop2: parseInt(document.getElementById('loop2').value),
                loop3: parseInt(document.getElementById('loop3').value),
                t1x: parseInt(document.getElementById('t1x').value),
                t1y: parseInt(document.getElementById('t1y').value),
                t1z: parseInt(document.getElementById('t1z').value),
                t1t: parseFloat(document.getElementById('t1t').value),
                t2x: parseInt(document.getElementById('t2x').value),
                t2y: parseInt(document.getElementById('t2y').value),
                t2z: parseInt(document.getElementById('t2z').value),
                t2t: parseFloat(document.getElementById('t2t').value),
                t3x: parseInt(document.getElementById('t3x').value),
                t3y: parseInt(document.getElementById('t3y').value),
                t3z: parseInt(document.getElementById('t3z').value),
                t3t: parseFloat(document.getElementById('t3t').value),
                merge: document.getElementById('merge-toggle').checked,
                colors: {
                    skb1: getComputedStyle(document.documentElement).getPropertyValue('--skb1-color').trim() || '#ff6b9d',
                    skb2: getComputedStyle(document.documentElement).getPropertyValue('--skb2-color').trim() || '#4fc3f7',
                    skb3: getComputedStyle(document.documentElement).getPropertyValue('--skb3-color').trim() || '#81c784'
                }
            };
        }
        
        // Enhanced render function with better error handling
        function renderVisualization(data, params) {
            const plotDiv = document.getElementById('plot');
            
            if (!plotDiv) {
                throw new Error("Plot container not found");
            }
            
            // Clean up existing plot if it exists
            if (plotDiv && plotDiv._fullLayout) {
                Plotly.purge(plotDiv);
            }
            
            const layout = createEnhancedLayout(params.merge);
            console.log("Rendering plot with layout:", layout);
            
            // Create new plot with enhanced configuration
            return Plotly.newPlot('plot', data.plot.data, layout, {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: [
                    'pan2d', 'select2d', 'lasso2d', 'autoScale2d', 
                    'hoverClosestCartesian', 'hoverCompareCartesian', 
                    'toggleSpikelines', 'resetScale2d'
                ],
                toImageButtonOptions: {
                    format: 'png',
                    filename: 'skb_visualization',
                    height: 800,
                    width: 1200,
                    scale: 2
                }
            }).then(() => {
                console.log("Plot updated successfully");
                
                // Apply enhanced defaults and optimizations
                if (window.PlotlyDefaults && window.PlotlyDefaults.updatePlotWithDefaults) {
                    PlotlyDefaults.updatePlotWithDefaults(plotDiv, layout);
                }
                
                // Update topological properties
                updateTopologicalProperties();
                
                // Cache frame if animating
                if (isAnimating && smoothAnimationEnabled) {
                    cacheAnimationFrame(params);
                }
            });
        }
        
        // Enhanced layout creation with scientific precision
        function createEnhancedLayout(isMerged) {
            const plotContainer = document.getElementById('plot');
            const width = plotContainer ? plotContainer.offsetWidth : 800;
            const height = plotContainer ? plotContainer.offsetHeight : 600;

            return {
                scene: {
                    aspectmode: 'cube',
                    camera: {
                        eye: { x: 2.1, y: 2.1, z: 1.8 },
                        center: { x: 0, y: 0, z: 0 },
                        up: { x: 0, y: 0, z: 1 },
                        projection: { type: 'perspective' }
                    },
                    xaxis: {
                        title: { text: 'X', font: { color: '#e2e8f0', size: 12 } },
                        showspikes: false,
                        showgrid: true,
                        zeroline: true,
                        showline: false,
                        showticklabels: true,
                        gridcolor: 'rgba(226, 232, 240, 0.15)',
                        zerolinecolor: 'rgba(226, 232, 240, 0.3)',
                        tickfont: { color: '#a0aec0', size: 10 },
                        range: [-4, 4]
                    },
                    yaxis: {
                        title: { text: 'Y', font: { color: '#e2e8f0', size: 12 } },
                        showspikes: false,
                        showgrid: true,
                        zeroline: true,
                        showline: false,
                        showticklabels: true,
                        gridcolor: 'rgba(226, 232, 240, 0.15)',
                        zerolinecolor: 'rgba(226, 232, 240, 0.3)',
                        tickfont: { color: '#a0aec0', size: 10 },
                        range: [-4, 4]
                    },
                    zaxis: {
                        title: { text: 'Z', font: { color: '#e2e8f0', size: 12 } },
                        showspikes: false,
                        showgrid: true,
                        zeroline: true,
                        showline: false,
                        showticklabels: true,
                        gridcolor: 'rgba(226, 232, 240, 0.15)',
                        zerolinecolor: 'rgba(226, 232, 240, 0.3)',
                        tickfont: { color: '#a0aec0', size: 10 },
                        range: [-3, 3]
                    },
                    bgcolor: 'rgba(15, 20, 25, 0.95)',
                    dragmode: 'orbit'
                },
                paper_bgcolor: 'rgba(15, 20, 25, 0.98)',
                plot_bgcolor: 'rgba(15, 20, 25, 0.95)',
                margin: { l: 0, r: 0, b: 0, t: 30, pad: 0 },
                width: width,
                height: height,
                autosize: true,
                legend: {
                    font: { color: '#e2e8f0', size: 11 },
                    bgcolor: 'rgba(45, 55, 72, 0.9)',
                    bordercolor: 'rgba(255, 255, 255, 0.1)',
                    borderwidth: 1,
                    y: 0.98,
                    x: 0.02,
                    orientation: 'v'
                },
                hovermode: 'closest',
                showlegend: true,
                title: {
                    text: isMerged ? 'Merged SKB: Stable Hadron Configuration' : 'Individual Sub-SKBs: Quark-like Components',
                    font: { color: '#e2e8f0', size: 14 },
                    x: 0.5,
                    y: 0.97
                },
                annotations: [{
                    showarrow: false,
                    text: isMerged ? 'Topological Stability Analysis' : 'Component Interaction Visualization',
                    font: {
                        color: isMerged ? '#bb86fc' : '#4fc3f7',
                        size: 10
                    },
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.98,
                    y: 0.02
                }]
            };
        }
        
        // Enhanced topological properties calculation
        function updateTopologicalProperties() {
            try {
                const isMerged = document.getElementById('merge-toggle').checked;
                const eulerChar = document.getElementById('euler-characteristic');
                const genus = document.getElementById('genus');
                const homologyGroups = document.getElementById('homology-groups');
                const stiefelWhitney = document.getElementById('stiefel-whitney');
                const intersectionForm = document.getElementById('intersection-form');
                const kirbySiebenmann = document.getElementById('kirby-siebenmann');
                const compatibilityStatus = document.getElementById('compatibility-status');
                const ctcStability = document.getElementById('ctc-stability');
                
                // Get current parameter values
                const params = getVisualizationParameters();
                
                if (isMerged) {
                    // Merged Klein bottle properties
                    eulerChar.textContent = "0";
                    genus.textContent = "2";
                    homologyGroups.textContent = "H₁ = Z ⊕ Z₂";
                    
                    // Enhanced topological calculations
                    const orientable = (params.t1x + params.t2y + params.t3z) % 2 === 0;
                    stiefelWhitney.textContent = orientable ? "w₁ = 0, w₂ = 0" : `w₁ = 1, w₂ = ${(params.t1y * params.t2z - params.t1z * params.t2y) % 2}`;
                    
                    // Enhanced intersection form calculation
                    const sumTwists = Math.abs(params.t1x + params.t2x + params.t3x) + 
                                     Math.abs(params.t1y + params.t2y + params.t3y) + 
                                     Math.abs(params.t1z + params.t2z + params.t3z);
                    
                    let formType = "";
                    if (sumTwists < 3) formType = "[ ]"; // Trivial
                    else if (sumTwists % 2 === 0) formType = "[ 1 0; 0 -1 ]"; // Indefinite
                    else formType = "[ 1 0; 0 1 ]"; // Positive definite
                    intersectionForm.textContent = "Q = " + formType;
                    
                    // Kirby-Siebenmann invariant
                    const ks = ((params.loop1 * params.loop2 * params.loop3) % 2);
                    kirbySiebenmann.textContent = ks.toString();
                    
                    // Enhanced CTC stability analysis
                    const timeSum = Math.abs(params.t1t + params.t2t + params.t3t);
                    const stableCTC = timeSum < 0.3;
                    ctcStability.textContent = stableCTC ? "Stable" : "Unstable";
                    ctcStability.className = stableCTC ? "property-value compatible-status" : "property-value incompatible-status";
                    
                    // Enhanced compatibility determination
                    const compatible = orientable && sumTwists >= 3 && ks === 0 && stableCTC;
                    compatibilityStatus.textContent = compatible ? "Compatible" : 
                        (!stableCTC ? "Incompatible - Unstable CTCs" : "Incompatible");
                    
                    compatibilityStatus.className = compatible ? "property-value compatible-status" : "property-value incompatible-status";
                    
                } else {
                    // Individual sub-SKB properties
                    eulerChar.textContent = "0";
                    genus.textContent = "1";
                    homologyGroups.textContent = "H₁ = Z";
                    stiefelWhitney.textContent = "w₁ = 1, w₂ = 0";
                    intersectionForm.textContent = "Q = [ ]";
                    kirbySiebenmann.textContent = "0";
                    ctcStability.textContent = "N/A";
                    ctcStability.className = "property-value neutral-status";
                    compatibilityStatus.textContent = "Requires Merging";
                    compatibilityStatus.className = "property-value neutral-status";
                }
                
                // Animate property changes
                document.querySelectorAll('.property-value').forEach(el => {
                    el.classList.remove('highlight');
                    void el.offsetWidth;
                    el.classList.add('highlight');
                });
                
            } catch (error) {
                console.warn("Error updating topological properties:", error);
            }
        }
        
        // Enhanced reset function
        function resetControls() {
            console.log("Resetting all controls...");
            
            // Stop animation if running
            if (isAnimating) {
                toggleAnimation();
            }
            
            // Reset all sliders to default values
            const sliderDefaults = {
                'time': 0,
                'loop-factor': 1,
                'loop1': 1, 'loop2': 1, 'loop3': 1,
                't1x': 0, 't1y': 0, 't1z': 0, 't1t': 0,
                't2x': 0, 't2y': 0, 't2z': 0, 't2t': 0,
                't3x': 0, 't3y': 0, 't3z': 0, 't3t': 0
            };
            
            Object.entries(sliderDefaults).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = value;
                    updateSliderValue(id);
                }
            });
            
            // Reset toggle
            const mergeToggle = document.getElementById('merge-toggle');
            if (mergeToggle) {
                mergeToggle.checked = false;
            }
            
            // Clear animation cache
            animationFrameCache.clear();
            frameIndex = 0;
            
            // Update visualization
            setTimeout(() => {
                updateVisualization();
            }, 100);
        }
        
        // Enhanced animation with pre-recorded smooth playback
        function toggleAnimation() {
            const animateBtn = document.getElementById('animate-btn');
            const animateIcon = document.getElementById('animate-icon');
            const animateText = document.getElementById('animate-text');
            const timeSlider = document.getElementById('time');
            
            if (!animateBtn || !animateIcon || !animateText || !timeSlider) {
                console.error("Animation control elements not found");
                return;
            }
            
            isAnimating = !isAnimating;
            
            if (isAnimating) {
                console.log("Starting animation...");
                animateIcon.className = 'fas fa-pause';
                animateText.textContent = 'Pause';
                animateBtn.classList.add('active');
                
                // Enhanced smooth animation function
                const animate = () => {
                    if (!isAnimating) return;
                    
                    let currentTime = parseFloat(timeSlider.value);
                    currentTime = (currentTime + 0.04) % 6.28; // Smaller steps for smoother animation
                    
                    timeSlider.value = currentTime.toFixed(2);
                    updateSliderValue('time');
                    
                    // Use cached frame if available for smoother playback
                    if (smoothAnimationEnabled && shouldUseCachedFrame(currentTime)) {
                        const cachedData = getCachedFrame(currentTime);
                        if (cachedData) {
                            try {
                                renderVisualization(cachedData.data, cachedData.params);
                            } catch (error) {
                                console.warn("Error rendering cached frame:", error);
                                updateVisualization();
                            }
                        } else {
                            updateVisualization();
                        }
                    } else {
                        updateVisualization();
                    }
                    
                    animationId = requestAnimationFrame(animate);
                };
                
                animationId = requestAnimationFrame(animate);
                
            } else {
                console.log("Stopping animation...");
                animateIcon.className = 'fas fa-play';
                animateText.textContent = 'Animate';
                animateBtn.classList.remove('active');
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }
            }
        }
        
        // Animation caching system for smooth playback
        function cacheAnimationFrame(params) {
            if (animationFrameCache.size > 100) { // Limit cache size
                const firstKey = animationFrameCache.keys().next().value;
                animationFrameCache.delete(firstKey);
            }
            
            const cacheKey = Math.round(params.t * 100) / 100; // Round to 2 decimal places
            animationFrameCache.set(cacheKey, {
                data: { plot: { data: getCurrentPlotData() } },
                params: { ...params }
            });
        }
        
        function shouldUseCachedFrame(time) {
            const cacheKey = Math.round(time * 100) / 100;
            return animationFrameCache.has(cacheKey);
        }
        
        function getCachedFrame(time) {
            const cacheKey = Math.round(time * 100) / 100;
            return animationFrameCache.get(cacheKey);
        }
        
        function getCurrentPlotData() {
            const plotDiv = document.getElementById('plot');
            if (plotDiv && plotDiv.data) {
                return plotDiv.data;
            }
            return [];
        }
        
        // Enhanced error display
        function showErrorMessage(message) {
            const controlsPanel = document.querySelector('.controls-panel');
            if (!controlsPanel) return;
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            
            controlsPanel.insertBefore(errorDiv, controlsPanel.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }
        
        // Enhanced help modal functions
        function toggleHelpModal() {
            const modal = document.getElementById('help-modal');
            if (!modal) return;
            
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            } else {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }
        
        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Initializing enhanced visualization system...");
            
            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error("Plotly library is not loaded! This will prevent visualizations from working.");
                showErrorMessage("Visualization library (Plotly) failed to load. Please try refreshing the page.");
                return;
            } else {
                console.log("Plotly visualization library loaded successfully: v" + Plotly.version);
            }
            
            // Initialize all sliders
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                updateSliderValue(slider.id);
                
                // Add enhanced event listeners
                slider.addEventListener('input', function() {
                    updateSliderValue(this.id);
                });
                
                slider.addEventListener('change', function() {
                    updateVisualization();
                });
            });
            
            // Initialize visualization
            try {
                updateVisualization();
            } catch (error) {
                console.error("Error during initial visualization:", error);
                showErrorMessage("Failed to initialize visualization: " + error.message);
            }
            
            // Enhanced keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName.toLowerCase() === 'input') return; // Don't interfere with input fields
                
                switch(e.key.toLowerCase()) {
                    case 'h':
                        toggleHelpModal();
                        break;
                    case 'r':
                        resetControls();
                        break;
                    case ' ': // Space bar
                        toggleAnimation();
                        e.preventDefault();
                        break;
                    case 'escape':
                        if (document.getElementById('help-modal').style.display === 'flex') {
                            toggleHelpModal();
                        }
                        break;
                }
            });
            
            // Close modal when clicking outside
            document.getElementById('help-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    toggleHelpModal();
                }
            });
            
            console.log("Enhanced visualization system initialized successfully!");
        });

        // Enhanced resize observer for responsive design
        document.addEventListener('DOMContentLoaded', function() {
            const plotContainer = document.getElementById('plot');
            if (!plotContainer) return;
            
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (entry.target === plotContainer && typeof Plotly !== 'undefined' && Plotly.hasPlot('plot')) {
                        try {
                            const isMerged = document.getElementById('merge-toggle').checked;
                            const layout = createEnhancedLayout(isMerged);
                            Plotly.relayout('plot', {
                                width: entry.contentRect.width,
                                height: entry.contentRect.height,
                                ...layout
                            });
                        } catch (error) {
                            console.warn('Error in Plotly relayout during resize:', error);
                        }
                    }
                }
            });
            
            resizeObserver.observe(plotContainer);
        });

        // Window resize handler
        window.addEventListener('resize', function() {
            const plotContainer = document.getElementById('plot');
            if (plotContainer && typeof Plotly !== 'undefined' && Plotly.hasPlot('plot')) {
                try {
                    const isMerged = document.getElementById('merge-toggle').checked;
                    const layout = createEnhancedLayout(isMerged);
                    Plotly.relayout('plot', layout);
                } catch (error) {
                    console.warn('Error in Plotly relayout during window resize:', error);
                }
            }
        });
        
        // Performance monitoring
        let performanceMetrics = {
            updateCount: 0,
            averageUpdateTime: 0,
            lastUpdateDuration: 0
        };
        
        function logPerformance(startTime) {
            const duration = Date.now() - startTime;
            performanceMetrics.updateCount++;
            performanceMetrics.lastUpdateDuration = duration;
            performanceMetrics.averageUpdateTime = (
                (performanceMetrics.averageUpdateTime * (performanceMetrics.updateCount - 1) + duration) / 
                performanceMetrics.updateCount
            );
            
            if (duration > 1000) { // Log slow updates
                console.warn(`Slow visualization update: ${duration}ms`);
            }
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Enhanced dropdown handling for mobile
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        const dropdown = this.closest('.nav-dropdown');
                        const dropdownMenu = dropdown.querySelector('.dropdown-menu');
                        
                        // Close all other menus
                        document.querySelectorAll('.dropdown-menu').forEach(menu => {
                            if (menu !== dropdownMenu) {
                                menu.classList.remove('show');
                            }
                        });
                        
                        // Toggle this menu
                        dropdownMenu.classList.toggle('show');
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
            
            // Add active class to parent dropdown if child link is active
            const activeLinks = document.querySelectorAll('.dropdown-menu a.active');
            activeLinks.forEach(link => {
                const parentDropdown = link.closest('.nav-dropdown');
                if (parentDropdown) {
                    const dropdownToggle = parentDropdown.querySelector('.dropdown-toggle');
                    if (dropdownToggle) {
                        dropdownToggle.classList.add('active');
                    }
                }
            });
        });
    </script>
{% endblock %}
