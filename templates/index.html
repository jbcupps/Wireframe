<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spacetime Klein Bottle Visualization</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            /* Modern color palette */
            --dark-bg: #121212;
            --surface: #1e1e1e;
            --surface-light: #2d2d2d;
            --primary: #BB86FC;
            --primary-variant: #3700B3;
            --secondary: #03DAC6;
            --accent: #CF6679;
            --text-primary: rgba(255, 255, 255, 0.87);
            --text-secondary: rgba(255, 255, 255, 0.6);
            --border-color: rgba(255, 255, 255, 0.12);
            
            /* SKB Colors - now with better contrast for dark mode */
            --skb1-color: #FF6E91;  /* Vivid pink */
            --skb2-color: #33C4FF;  /* Bright blue */
            --skb3-color: #65FF8F;  /* Bright green */
            --skb-merged: #BB86FC;  /* Purple */
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        h1 {
            font-size: 2.2rem;
            font-weight: 300;
            margin: 0;
            letter-spacing: 0.5px;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 400;
            margin-top: 0;
            color: var(--text-secondary);
        }
        
        .main-content {
            display: flex;
            flex-direction: row;
            gap: 20px;
        }
        
        .visualization-panel {
            flex: 3;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
        }
        
        .plot-container {
            height: 700px;
            width: 100%;
        }
        
        .controls-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
            max-width: 350px;
        }
        
        .control-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }
        
        .slider-container {
            margin-bottom: 15px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding-right: 35px; /* Make room for the value display */
        }
        
        /* Standard appearance property for all form elements */
        input, select, button, textarea {
            -webkit-appearance: none;
            -moz-appearance: none;
            -ms-appearance: none;
            appearance: none;
            border-radius: 0;
            font-family: inherit;
        }
        
        /* Reset to browser defaults where needed */
        input[type="checkbox"], 
        input[type="radio"] {
            -webkit-appearance: auto;
            -moz-appearance: auto;
            -ms-appearance: auto;
            appearance: auto;
        }
        
        input[type="range"] {
            width: 100%;
            height: 4px;
            background: var(--surface-light);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-top: 8px;
        }
        
        input[type="range"]:hover {
            opacity: 1;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            transition: all 0.2s;
        }
        
        input[type="range"]::-ms-thumb {
            width: 18px;
            height: 18px;
            background: var(--primary);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            transition: all 0.2s;
        }
        
        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--primary-variant);
            transform: scale(1.1);
        }
        
        input[type="range"]::-moz-range-thumb:hover {
            background: var(--primary-variant);
            transform: scale(1.1);
        }
        
        input[type="range"]::-ms-thumb:hover {
            background: var(--primary-variant);
            transform: scale(1.1);
        }
        
        .value-display {
            position: absolute;
            right: 0;
            top: 0;
            width: 30px;
            text-align: right;
            color: var(--primary);
            font-weight: 500;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        button {
            background-color: var(--primary);
            color: #000;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        button:hover {
            background-color: var(--primary-variant);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }
        
        .toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 26px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
            margin: 0;
            padding: 0;
            position: absolute;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--surface-light);
            -webkit-transition: .4s;
            -moz-transition: .4s;
            -ms-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .3s;
            -moz-transition: .3s;
            -ms-transition: .3s;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary);
        }
        
        input:checked + .toggle-slider:before {
            -webkit-transform: translateX(26px);
            -moz-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        
        .toggle-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .twist-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .twist-axis {
            flex: 1;
            min-width: 70px;
        }
        
        .sub-skb-section {
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .skb1 {
            border-left: 3px solid var(--skb1-color);
            padding-left: 12px;
        }
        
        .skb2 {
            border-left: 3px solid var(--skb2-color);
            padding-left: 12px;
        }
        
        .skb3 {
            border-left: 3px solid var(--skb3-color);
            padding-left: 12px;
        }
        
        .sub-skb-title {
            font-weight: 500;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .color-skb1 {
            background-color: var(--skb1-color);
        }
        
        .color-skb2 {
            background-color: var(--skb2-color);
        }
        
        .color-skb3 {
            background-color: var(--skb3-color);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .tooltip .tooltip-icon {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--surface-light);
            color: var(--text-primary);
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.8rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .properties-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            width: 250px;
            z-index: 100;
            font-size: 0.9rem;
        }
        
        .properties-title {
            font-weight: 500;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        
        .property-item {
            margin-bottom: 8px;
        }
        
        .property-name {
            color: var(--text-secondary);
            margin-right: 10px;
        }
        
        .property-value {
            color: var(--primary);
            font-family: monospace;
        }
        
        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            background-color: var(--primary-variant);
            color: white;
        }
        
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1001;
            align-items: center;
            justify-content: center;
        }
        
        .help-content {
            background-color: var(--surface);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            border-radius: 12px;
            padding: 30px;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .close-help {
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .close-help:hover {
            color: var(--primary);
        }
        
        .help-section {
            margin-bottom: 20px;
        }
        
        .help-subtitle {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        
        /* Animation for property changes */
        @keyframes highlight {
            0% { background-color: rgba(187, 134, 252, 0.2); }
            100% { background-color: transparent; }
        }
        
        .highlight {
            animation: highlight 2s ease-out;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .controls-panel {
                max-width: 100%;
            }
            
            .plot-container {
                height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .twist-controls {
                flex-direction: column;
            }
            
            .properties-panel {
                position: static;
                width: auto;
                margin-top: 20px;
            }
        }
        
        .research-links {
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .research-links a {
            color: var(--primary);
            text-decoration: none;
            transition: all 0.2s ease;
        }
        
        .research-links a:hover {
            color: var(--secondary);
            text-decoration: underline;
        }
        
        /* Adjust tooltip positioning for control headers */
        .sub-skb-title .tooltip {
            margin-left: 8px;
        }
        
        /* Adjust tooltip positioning for twist controls */
        .twist-axis .tooltip {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .twist-axis {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Spacetime Klein Bottle Visualization</h1>
            <h2>Interactive Topology Explorer</h2>
            <div class="research-links">
                <p>Based on research:
                    <a href="https://figshare.com/articles/preprint/A_Categorical_Framework_for_Topological_Features_of_Spacetime_Klein_Bottles_in_Particle_Physics/28466279?file=52550969" target="_blank">Categorical Framework for SKBs</a> | 
                    <a href="https://figshare.com/articles/preprint/4D_Spacetime_Klein_Bottles_as_Fundamental_Particle_Models_pdf/28466276?file=52550963" target="_blank">4D SKBs as Particle Models</a>
                </p>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Visualization panel with the plot and properties -->
            <div class="visualization-panel">
                <div id="plot" class="plot-container"></div>
                
                <!-- Topological properties panel -->
                <div class="properties-panel">
                    <div class="properties-title">Topological Properties</div>
                    <div class="property-item">
                        <span class="property-name">Euler Characteristic:</span>
                        <span class="property-value" id="euler-characteristic">0</span>
                    </div>
                    <div class="property-item">
                        <span class="property-name">Genus:</span>
                        <span class="property-value" id="genus">1</span>
                    </div>
                    <div class="property-item">
                        <span class="property-name">Homology Groups:</span>
                        <span class="property-value" id="homology-groups">H₁ = Z ⊕ Z₂</span>
                    </div>
                </div>
            </div>
            
            <!-- Controls panel -->
            <div class="controls-panel">
                <!-- Global controls card -->
                <div class="control-card">
                    <div class="card-header">
                        <h3 class="card-title">Global Controls</h3>
                    </div>
                    
                    <div class="toggle-container">
                        <span class="toggle-label">Individual SKBs</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="merge-toggle" onchange="updateVisualization()">
                            <span class="toggle-slider"></span>
                        </label>
                        <span class="toggle-label">Merged SKB</span>
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Toggle between individual sub-SKBs (representing quark-like components) and merged stable SKB (representing a composite particle). In categorical theory, this represents a colimit of the sub-objects.</span>
                        </div>
                    </div>
                    
                    <div class="slider-container">
                        <label for="time">Time Evolution <span id="time-value" class="value-display">0</span></label>
                        <input type="range" id="time" min="0" max="6.28" value="0" step="0.1" oninput="updateSliderValue('time'); updateVisualization();">
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Controls the time parameter, simulating evolution through closed timelike curves (CTCs). In 4D SKB theory, this represents how particles evolve through spacetime while maintaining their topological identity.</span>
                        </div>
                    </div>
                    
                    <div class="slider-container">
                        <label for="loop-factor">Global Loop Factor <span id="loop-factor-value" class="value-display">1</span></label>
                        <input type="range" id="loop-factor" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop-factor'); updateVisualization();">
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Controls the number of loops in the merged structure. Higher values create more complex structures. In SKB theory, loop factors correspond to energy levels and may relate to particle mass through topological complexity.</span>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-SKB 1 Controls -->
                <div class="control-card">
                    <div class="sub-skb-title skb1">
                        <span class="color-indicator color-skb1"></span>Sub-SKB 1
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">First quark-like component in the categorical SKB framework. In particle physics analogy, this might represent an "up" quark with specific topological features that contribute to its properties.</span>
                        </div>
                    </div>
                    
                    <div class="slider-container">
                        <label for="loop1">Loop Factor <span id="loop1-value" class="value-display">1</span></label>
                        <input type="range" id="loop1" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop1'); updateVisualization();">
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Controls the number of loops in this sub-SKB. In the categorical framework, this is related to the first homology group generators and may correspond to a particle's internal energy configurations.</span>
                        </div>
                    </div>
                    
                    <div class="sub-skb-section">
                        <div class="twist-controls">
                            <div class="twist-axis">
                                <label for="t1x">X-Twist <span id="t1x-value" class="value-display">0</span></label>
                                <input type="range" id="t1x" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t1x'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">X-axis twist parameter for sub-SKB 1. In the 4D model, this relates to spatial twisting in the first dimension and may correspond to specific quantum numbers.</span>
                                </div>
                            </div>
                            <div class="twist-axis">
                                <label for="t1y">Y-Twist <span id="t1y-value" class="value-display">0</span></label>
                                <input type="range" id="t1y" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t1y'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">Y-axis twist parameter for sub-SKB 1. This represents torsion in the second spatial dimension and may relate to particle spin properties.</span>
                                </div>
                            </div>
                            <div class="twist-axis">
                                <label for="t1z">Z-Twist <span id="t1z-value" class="value-display">0</span></label>
                                <input type="range" id="t1z" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t1z'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">Z-axis twist parameter for sub-SKB 1. Controls vertical torsion and may relate to charge properties in the SKB particle model.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-SKB 2 Controls -->
                <div class="control-card">
                    <div class="sub-skb-title skb2">
                        <span class="color-indicator color-skb2"></span>Sub-SKB 2
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Second quark-like component in the SKB framework. In particle physics analogy, this might represent another "up" quark with complementary topological features to the first.</span>
                        </div>
                    </div>
                    
                    <div class="slider-container">
                        <label for="loop2">Loop Factor <span id="loop2-value" class="value-display">1</span></label>
                        <input type="range" id="loop2" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop2'); updateVisualization();">
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Controls the number of loops in the second sub-SKB. In the categorical model, different loop configurations may represent different energy states or quantum excitations.</span>
                        </div>
                    </div>
                    
                    <div class="sub-skb-section">
                        <div class="twist-controls">
                            <div class="twist-axis">
                                <label for="t2x">X-Twist <span id="t2x-value" class="value-display">0</span></label>
                                <input type="range" id="t2x" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t2x'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">X-axis twist for the second sub-SKB. Combinations of twists between different sub-SKBs may represent particle interactions in the categorical model.</span>
                                </div>
                            </div>
                            <div class="twist-axis">
                                <label for="t2y">Y-Twist <span id="t2y-value" class="value-display">0</span></label>
                                <input type="range" id="t2y" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t2y'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">Y-axis twist for sub-SKB 2. The relative Y-twist values between sub-SKBs may correspond to binding energies in the composite structure.</span>
                                </div>
                            </div>
                            <div class="twist-axis">
                                <label for="t2z">Z-Twist <span id="t2z-value" class="value-display">0</span></label>
                                <input type="range" id="t2z" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t2z'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">Z-axis twist for sub-SKB 2. In the 4D spacetime model, this represents how this component interacts with the vertical dimension and may relate to strong force carrier interactions.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sub-SKB 3 Controls -->
                <div class="control-card">
                    <div class="sub-skb-title skb3">
                        <span class="color-indicator color-skb3"></span>Sub-SKB 3
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Third quark-like component in the SKB framework. In particle physics analogy, this might represent a "down" quark with distinct topological features that contribute to the composite particle's properties.</span>
                        </div>
                    </div>
                    
                    <div class="slider-container">
                        <label for="loop3">Loop Factor <span id="loop3-value" class="value-display">1</span></label>
                        <input type="range" id="loop3" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop3'); updateVisualization();">
                        <div class="tooltip">
                            <i class="fas fa-info-circle tooltip-icon"></i>
                            <span class="tooltip-text">Controls the number of loops in the third sub-SKB. In topological terms, this may represent how many times this component wraps around itself, affecting its contribution to the overall particle mass.</span>
                        </div>
                    </div>
                    
                    <div class="sub-skb-section">
                        <div class="twist-controls">
                            <div class="twist-axis">
                                <label for="t3x">X-Twist <span id="t3x-value" class="value-display">0</span></label>
                                <input type="range" id="t3x" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t3x'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">X-axis twist for sub-SKB 3. In the categorical framework, this corresponds to a specific morphism that alters the topology in ways that may relate to flavor quantum numbers.</span>
                                </div>
                            </div>
                            <div class="twist-axis">
                                <label for="t3y">Y-Twist <span id="t3y-value" class="value-display">0</span></label>
                                <input type="range" id="t3y" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t3y'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">Y-axis twist for sub-SKB 3. Different twist configurations across all sub-SKBs may correspond to different particle states or resonances in the SKB model.</span>
                                </div>
                            </div>
                            <div class="twist-axis">
                                <label for="t3z">Z-Twist <span id="t3z-value" class="value-display">0</span></label>
                                <input type="range" id="t3z" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t3z'); updateVisualization();">
                                <div class="tooltip">
                                    <i class="fas fa-info-circle tooltip-icon"></i>
                                    <span class="tooltip-text">Z-axis twist for sub-SKB 3. In the spacetime model with closed timelike curves, this parameter may influence how this component interacts with the time dimension.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="button-group">
                    <button id="reset-btn" onclick="resetControls()">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                    <button id="animate-btn" onclick="toggleAnimation()">
                        <i class="fas fa-play" id="animate-icon"></i> <span id="animate-text">Animate</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Button and Modal -->
    <div class="help-button" onclick="toggleHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>Interactive Guide</h2>
                <span class="close-help" onclick="toggleHelpModal()">&times;</span>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">What is a Spacetime Klein Bottle?</h3>
                <p>A Spacetime Klein Bottle (SKB) is a non-orientable topological surface with no boundary embedded in 4D spacetime with closed timelike curves. In this model, fundamental particles are represented as SKBs, with intrinsic properties like mass and charge emerging from their topology.</p>
                <p>This visualization is based on research papers exploring a novel hypothesis where quarks and baryons can be modeled using topological structures:</p>
                <ul>
                    <li><a href="https://figshare.com/articles/preprint/A_Categorical_Framework_for_Topological_Features_of_Spacetime_Klein_Bottles_in_Particle_Physics/28466279?file=52550969" target="_blank">A Categorical Framework for Topological Features of Spacetime Klein Bottles in Particle Physics</a></li>
                    <li><a href="https://figshare.com/articles/preprint/4D_Spacetime_Klein_Bottles_as_Fundamental_Particle_Models_pdf/28466276?file=52550963" target="_blank">4D Spacetime Klein Bottles as Fundamental Particle Models</a></li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Basic Controls</h3>
                <ul>
                    <li><strong>Merged Mode:</strong> Toggle between viewing individual sub-SKBs or a merged stable SKB.</li>
                    <li><strong>Time Evolution:</strong> Controls the time parameter, changing the shape dynamically.</li>
                    <li><strong>Loop Factor:</strong> Adjusts the number of loops in the structure.</li>
                    <li><strong>Twist Controls:</strong> Modify the twist parameters along the X, Y, and Z axes.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Navigation Tips</h3>
                <p>The 3D visualization supports the following interactions:</p>
                <ul>
                    <li><strong>Rotate:</strong> Click and drag to rotate the view.</li>
                    <li><strong>Zoom:</strong> Use the scroll wheel or pinch gesture to zoom in/out.</li>
                    <li><strong>Pan:</strong> Right-click and drag (or two-finger drag) to pan the view.</li>
                    <li><strong>Reset View:</strong> Double-click to reset the camera position.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Topological Properties</h3>
                <p>The properties panel displays key mathematical characteristics of the current structure:</p>
                <ul>
                    <li><strong>Euler Characteristic:</strong> A topological invariant, calculated as V - E + F (vertices - edges + faces). For Klein bottles, this is always 0.</li>
                    <li><strong>Genus:</strong> Roughly corresponds to the number of "holes" in the surface. In SKB theory, this relates to particle generation.</li>
                    <li><strong>Homology Groups:</strong> Algebraic structures that capture the essential topological features. For Klein bottles, H₁ = Z ⊕ Z₂, representing its non-orientability and loop structure.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Physical Interpretation</h3>
                <p>In the SKB model of fundamental particles:</p>
                <ul>
                    <li><strong>Sub-SKBs:</strong> Represent quark-like components with distinct topological features</li>
                    <li><strong>Twist Parameters:</strong> May correspond to quantum numbers like charge, spin, or color</li>
                    <li><strong>Loop Factors:</strong> Potentially relate to energy levels and mass</li>
                    <li><strong>Merged SKB:</strong> Represents a composite particle (like a baryon) formed by combining sub-SKBs</li>
                    <li><strong>Time Evolution:</strong> Visualizes how particles evolve through closed timelike curves while maintaining their identity</li>
                </ul>
                <p>This visualization tool allows exploration of how different topological configurations might correspond to different particle states and properties.</p>
            </div>
        </div>
    </div>
    
    <script>
        let animationId = null;
        let isAnimating = false;
        
        // Function to update slider value display
        function updateSliderValue(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + '-value');
            display.textContent = slider.value;
            
            // Highlight the value with animation
            display.classList.remove('highlight');
            void display.offsetWidth; // Trigger reflow to restart animation
            display.classList.add('highlight');
            
            // Update topological properties
            updateTopologicalProperties();
        }
        
        // Function to update visualization
        function updateVisualization() {
            const params = {
                time: parseFloat(document.getElementById('time').value),
                loop_factor: parseInt(document.getElementById('loop-factor').value),
                loop1: parseInt(document.getElementById('loop1').value),
                loop2: parseInt(document.getElementById('loop2').value),
                loop3: parseInt(document.getElementById('loop3').value),
                t1x: parseInt(document.getElementById('t1x').value),
                t1y: parseInt(document.getElementById('t1y').value),
                t1z: parseInt(document.getElementById('t1z').value),
                t2x: parseInt(document.getElementById('t2x').value),
                t2y: parseInt(document.getElementById('t2y').value),
                t2z: parseInt(document.getElementById('t2z').value),
                t3x: parseInt(document.getElementById('t3x').value),
                t3y: parseInt(document.getElementById('t3y').value),
                t3z: parseInt(document.getElementById('t3z').value),
                merge: document.getElementById('merge-toggle').checked ? 1 : 0,
                colors: {
                    skb1: getComputedStyle(document.documentElement).getPropertyValue('--skb1-color').trim(),
                    skb2: getComputedStyle(document.documentElement).getPropertyValue('--skb2-color').trim(),
                    skb3: getComputedStyle(document.documentElement).getPropertyValue('--skb3-color').trim()
                }
            };
            
            fetch('/get_visualization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error("Error:", data.error);
                    return;
                }
                
                Plotly.react('plot', data.plot.data, createLayout(params.merge));
                updateTopologicalProperties();
            })
            .catch(error => {
                console.error("Error fetching visualization:", error);
            });
        }
        
        // Function to create a custom layout
        function createLayout(isMerged) {
            return {
                scene: {
                    xaxis: { range: [-3, 3], title: "", showgrid: false, showline: true, zeroline: true, showticklabels: false },
                    yaxis: { range: [-3, 3], title: "", showgrid: false, showline: true, zeroline: true, showticklabels: false },
                    zaxis: { range: [-2, 2], title: "", showgrid: false, showline: true, zeroline: true, showticklabels: false },
                    aspectmode: 'cube',
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.2 }
                    },
                    bgcolor: 'rgba(0,0,0,0)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 0, r: 0, b: 0, t: 0, pad: 0 },
                height: isMerged ? 700 : 700,
                legend: {
                    font: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') },
                    bgcolor: 'rgba(30,30,30,0.7)',
                    bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                    borderwidth: 1,
                    y: 0.99,
                    x: 0.01
                },
                hovermode: false
            };
        }
        
        // Function to update topological properties based on current state
        function updateTopologicalProperties() {
            const isMerged = document.getElementById('merge-toggle').checked;
            const eulerChar = document.getElementById('euler-characteristic');
            const genus = document.getElementById('genus');
            const homologyGroups = document.getElementById('homology-groups');
            
            if (isMerged) {
                // Klein bottle properties
                eulerChar.textContent = "0";
                genus.textContent = "2";
                homologyGroups.textContent = "H₁ = Z ⊕ Z₂";
            } else {
                // Mobius strip-like properties (for individual sub-SKBs)
                eulerChar.textContent = "0";
                genus.textContent = "1";
                homologyGroups.textContent = "H₁ = Z";
            }
            
            // Animate the property changes
            document.querySelectorAll('.property-value').forEach(el => {
                el.classList.remove('highlight');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('highlight');
            });
        }
        
        // Function to reset all controls
        function resetControls() {
            // Stop animation if running
            if (isAnimating) {
                toggleAnimation();
            }
            
            // Reset all sliders to their default values
            document.getElementById('time').value = 0;
            document.getElementById('loop-factor').value = 1;
            document.getElementById('loop1').value = 1;
            document.getElementById('loop2').value = 1;
            document.getElementById('loop3').value = 1;
            document.getElementById('t1x').value = 0;
            document.getElementById('t1y').value = 0;
            document.getElementById('t1z').value = 0;
            document.getElementById('t2x').value = 0;
            document.getElementById('t2y').value = 0;
            document.getElementById('t2z').value = 0;
            document.getElementById('t3x').value = 0;
            document.getElementById('t3y').value = 0;
            document.getElementById('t3z').value = 0;
            document.getElementById('merge-toggle').checked = false;
            
            // Update all value displays
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                updateSliderValue(slider.id);
            });
            
            // Update visualization
            updateVisualization();
        }
        
        // Function to toggle animation
        function toggleAnimation() {
            const animateBtn = document.getElementById('animate-btn');
            const animateIcon = document.getElementById('animate-icon');
            const animateText = document.getElementById('animate-text');
            const timeSlider = document.getElementById('time');
            
            isAnimating = !isAnimating;
            
            if (isAnimating) {
                animateIcon.className = 'fas fa-pause';
                animateText.textContent = 'Pause';
                
                // Animation function
                const animate = () => {
                    let currentTime = parseFloat(timeSlider.value);
                    currentTime = (currentTime + 0.05) % 6.28;
                    timeSlider.value = currentTime.toFixed(2);
                    updateSliderValue('time');
                    updateVisualization();
                    animationId = requestAnimationFrame(animate);
                };
                
                animationId = requestAnimationFrame(animate);
            } else {
                animateIcon.className = 'fas fa-play';
                animateText.textContent = 'Animate';
                cancelAnimationFrame(animationId);
            }
        }
        
        // Function to toggle help modal
        function toggleHelpModal() {
            const modal = document.getElementById('help-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }
        
        // Initialize the visualization when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateVisualization();
            
            // Set up keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'h' || e.key === 'H') {
                    toggleHelpModal();
                } else if (e.key === 'r' || e.key === 'R') {
                    resetControls();
                } else if (e.key === ' ') { // Space bar
                    toggleAnimation();
                    e.preventDefault(); // Prevent page scrolling
                }
            });
        });
    </script>
</body>
</html>