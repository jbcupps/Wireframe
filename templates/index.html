<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4D Manifold Explorer - Visualization</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="{{ url_for('static', filename='js/plotly-defaults.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme-switcher.js') }}"></script>
    <style>
        /* Page-specific styles */
        .main-content {
            display: flex;
            flex-direction: row;
            gap: 20px;
            width: 100%;
            margin: 80px auto 0;
            padding: 0 20px;
            box-sizing: border-box;
        }
        
        .visualization-panel {
            flex: 3;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            position: relative;
            min-height: 500px;
            height: calc(100vh - 200px);
            max-height: 800px;
        }
        
        .plot-container {
            width: 100%;
            height: 100%;
            background-color: var(--surface);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .controls-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 300px;
            max-width: 350px;
            height: fit-content;
        }
        
        .control-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-title {
            font-size: 1.1rem;
            font-weight: 500;
            margin: 0;
        }
        
        /* Existing styles continue... */
    </style>
</head>
<body>
    <!-- Site Navigation Header -->
    <header class="site-header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="site-logo">
                    <i class="fas fa-cube"></i>
                    <span>4D Manifold Explorer</span>
                </a>
                <nav class="site-nav">
                    <a href="/">Home</a>
                    <a href="/visualization" class="active">Visualization</a>
                    <a href="/evolution">Evolution</a>
                    <div class="nav-dropdown">
                        <div class="dropdown-toggle">
                            <span>Quantum Physics</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-menu">
                            <a href="/oscillator">Oscillator</a>
                            <a href="/double_slit">Double-Slit</a>
                            <a href="/quantum_tunneling">Quantum Tunneling</a>
                        </div>
                    </div>
                    <div class="nav-dropdown">
                        <div class="dropdown-toggle">
                            <span>Electromagnetism</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-menu">
                            <a href="/maxwell">Maxwell</a>
                            <a href="/maxwells">Maxwell's</a>
                        </div>
                    </div>
                    <div class="theme-toggle">
                        <i id="theme-icon-light" class="fas fa-sun theme-toggle-icon"></i>
                        <label class="theme-switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                        <i id="theme-icon-dark" class="fas fa-moon theme-toggle-icon"></i>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <div class="main-content">
        <div class="container">
            <!-- Main Page Header -->
            <header>
                <h1>Spacetime Klein Bottle 4D Manifold Explorer</h1>
                <div class="subtitle">Interactive visualization and exploration of 4D manifold topological structures</div>
            </header>
    
            <div class="research-links">
                <p>Research: <a href="https://figshare.com/articles/preprint/A_Categorical_Framework_for_Topological_Features_of_Spacetime_Klein_Bottles_in_Particle_Physics/28466279?file=52550969" target="_blank">Categorical Framework</a> | <a href="https://figshare.com/articles/preprint/4D_Spacetime_Klein_Bottles_as_Fundamental_Particle_Models_pdf/28466276?file=52550963" target="_blank">SKB Particle Models</a></p>
            </div>
    
            <div class="main-content">
                <!-- Visualization panel with the plot and properties -->
                <div class="visualization-panel">
                    <div id="plot" class="plot-container"></div>
                    
                    <!-- Topological properties panel -->
                    <div class="properties-panel">
                        <div class="properties-title">Topological Properties</div>
                        <div class="property-item">
                            <span class="property-name">Euler Characteristic:</span>
                            <span class="property-value" id="euler-characteristic">0</span>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Stiefel-Whitney Classes:</span>
                            <span class="property-value" id="stiefel-whitney">w₁ = 1, w₂ = 0</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Stiefel-Whitney classes are cohomology classes that characterize the twisting of the tangent bundle. w₁ indicates orientability (0 for orientable, 1 for non-orientable).</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Intersection Form:</span>
                            <span class="property-value" id="intersection-form">Q = { }</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">The intersection form is a symmetric bilinear form on the middle-dimensional homology. It describes how 2-cycles intersect in a 4-manifold and relates to particle interactions.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Kirby-Siebenmann Invariant:</span>
                            <span class="property-value" id="kirby-siebenmann">0</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">The Kirby-Siebenmann invariant is an obstruction to smoothing a 4-manifold. When non-zero, it indicates exotic smooth structures that may relate to quantum-gravitational effects in the SKB model.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">CTC Stability:</span>
                            <span class="property-value" id="ctc-stability">Stable</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Indicates whether the configuration allows for stable closed timelike curves (CTCs). Stability depends on the complementary nature of time twist parameters across sub-SKBs.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Compatibility:</span>
                            <span class="property-value" id="compatibility-status">Compatible</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Indicates whether the current SKB configuration is compatible with stable hadron formation based on topological constraints and CTC stability.</span>
                            </div>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Genus:</span>
                            <span class="property-value" id="genus">1</span>
                        </div>
                        <div class="property-item">
                            <span class="property-name">Homology Groups:</span>
                            <span class="property-value" id="homology-groups">H₁ = Z ⊕ Z₂</span>
                        </div>
                    </div>
                </div>
                
                <!-- Controls panel -->
                <div class="controls-panel">
                    <!-- Global controls card -->
                    <div class="control-card">
                        <div class="card-header">
                            <h3 class="card-title">Global Controls</h3>
                        </div>
                        
                        <div class="toggle-container">
                            <span class="toggle-label">Individual SKBs</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="merge-toggle" onchange="updateVisualization()">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="toggle-label">Merged SKB</span>
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Toggle between individual sub-SKBs (representing quark-like components) and merged stable SKB (representing a composite particle). In categorical theory, this represents a colimit of the sub-objects.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="time">Time Evolution <span id="time-value" class="value-display">0</span></label>
                            <input type="range" id="time" min="0" max="6.28" value="0" step="0.1" oninput="updateSliderValue('time'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the time parameter, simulating evolution through closed timelike curves (CTCs). In 4D SKB theory, this represents how particles evolve through spacetime while maintaining their topological identity.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop-factor">Global Loop Factor <span id="loop-factor-value" class="value-display">1</span></label>
                            <input type="range" id="loop-factor" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop-factor'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in the merged structure. Higher values create more complex structures. In SKB theory, loop factors correspond to energy levels and may relate to particle mass through topological complexity.</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-SKB 1 Controls -->
                    <div class="control-card">
                        <div class="sub-skb-title skb1">
                            <span class="color-indicator color-skb1"></span>Sub-SKB 1
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">First quark-like component in the categorical SKB framework. In particle physics analogy, this might represent an "up" quark with specific topological features that contribute to its properties.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop1">Loop Factor <span id="loop1-value" class="value-display">1</span></label>
                            <input type="range" id="loop1" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop1'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in this sub-SKB. In the categorical framework, this is related to the first homology group generators and may correspond to a particle's internal energy configurations.</span>
                            </div>
                        </div>
                        
                        <div class="sub-skb-section">
                            <div class="twist-controls">
                                <div class="twist-axis">
                                    <label for="t1x">X-Twist <span id="t1x-value" class="value-display">0</span></label>
                                    <input type="range" id="t1x" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t1x'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">X-axis twist parameter for sub-SKB 1. In the 4D model, this relates to spatial twisting in the first dimension and may correspond to specific quantum numbers.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t1y">Y-Twist <span id="t1y-value" class="value-display">0</span></label>
                                    <input type="range" id="t1y" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t1y'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Y-axis twist parameter for sub-SKB 1. This represents torsion in the second spatial dimension and may relate to particle spin properties.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t1z">Z-Twist <span id="t1z-value" class="value-display">0</span></label>
                                    <input type="range" id="t1z" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t1z'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Z-axis twist parameter for sub-SKB 1. Controls vertical torsion and may relate to charge properties in the SKB particle model.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t1t">Time-Twist <span id="t1t-value" class="value-display">0</span></label>
                                    <input type="range" id="t1t" min="-1" max="1" value="0" step="0.1" oninput="updateSliderValue('t1t'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Controls the time-like twist parameter for Sub-SKB 1, affecting the formation of closed timelike curves (CTCs). Balancing time twists across Sub-SKBs is essential for CTC stability.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-SKB 2 Controls -->
                    <div class="control-card">
                        <div class="sub-skb-title skb2">
                            <span class="color-indicator color-skb2"></span>Sub-SKB 2
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Second quark-like component in the SKB framework. In particle physics analogy, this might represent another "up" quark with complementary topological features to the first.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop2">Loop Factor <span id="loop2-value" class="value-display">1</span></label>
                            <input type="range" id="loop2" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop2'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in the second sub-SKB. In the categorical model, different loop configurations may represent different energy states or quantum excitations.</span>
                            </div>
                        </div>
                        
                        <div class="sub-skb-section">
                            <div class="twist-controls">
                                <div class="twist-axis">
                                    <label for="t2x">X-Twist <span id="t2x-value" class="value-display">0</span></label>
                                    <input type="range" id="t2x" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t2x'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">X-axis twist for the second sub-SKB. Combinations of twists between different sub-SKBs may represent particle interactions in the categorical model.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t2y">Y-Twist <span id="t2y-value" class="value-display">0</span></label>
                                    <input type="range" id="t2y" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t2y'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Y-axis twist for sub-SKB 2. The relative Y-twist values between sub-SKBs may correspond to binding energies in the composite structure.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t2z">Z-Twist <span id="t2z-value" class="value-display">0</span></label>
                                    <input type="range" id="t2z" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t2z'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Z-axis twist for sub-SKB 2. In the 4D spacetime model, this represents how this component interacts with the vertical dimension and may relate to strong force carrier interactions.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t2t">Time-Twist <span id="t2t-value" class="value-display">0</span></label>
                                    <input type="range" id="t2t" min="-1" max="1" value="0" step="0.1" oninput="updateSliderValue('t2t'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Controls the time-like twist parameter for Sub-SKB 2, affecting the formation of closed timelike curves (CTCs). Balancing time twists across Sub-SKBs is essential for CTC stability.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-SKB 3 Controls -->
                    <div class="control-card">
                        <div class="sub-skb-title skb3">
                            <span class="color-indicator color-skb3"></span>Sub-SKB 3
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Third quark-like component in the SKB framework. In particle physics analogy, this might represent a "down" quark with distinct topological features that contribute to the composite particle's properties.</span>
                            </div>
                        </div>
                        
                        <div class="slider-container">
                            <label for="loop3">Loop Factor <span id="loop3-value" class="value-display">1</span></label>
                            <input type="range" id="loop3" min="1" max="5" value="1" step="1" oninput="updateSliderValue('loop3'); updateVisualization();">
                            <div class="tooltip">
                                <i class="fas fa-info-circle tooltip-icon"></i>
                                <span class="tooltip-text">Controls the number of loops in the third sub-SKB. In topological terms, this may represent how many times this component wraps around itself, affecting its contribution to the overall particle mass.</span>
                            </div>
                        </div>
                        
                        <div class="sub-skb-section">
                            <div class="twist-controls">
                                <div class="twist-axis">
                                    <label for="t3x">X-Twist <span id="t3x-value" class="value-display">0</span></label>
                                    <input type="range" id="t3x" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t3x'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">X-axis twist for sub-SKB 3. In the categorical framework, this corresponds to a specific morphism that alters the topology in ways that may relate to flavor quantum numbers.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t3y">Y-Twist <span id="t3y-value" class="value-display">0</span></label>
                                    <input type="range" id="t3y" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t3y'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Y-axis twist for sub-SKB 3. Different twist configurations across all sub-SKBs may correspond to different particle states or resonances in the SKB model.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t3z">Z-Twist <span id="t3z-value" class="value-display">0</span></label>
                                    <input type="range" id="t3z" min="-5" max="5" value="0" step="1" oninput="updateSliderValue('t3z'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Z-axis twist for sub-SKB 3. In the spacetime model with closed timelike curves, this parameter may influence how this component interacts with the time dimension.</span>
                                    </div>
                                </div>
                                <div class="twist-axis">
                                    <label for="t3t">Time-Twist <span id="t3t-value" class="value-display">0</span></label>
                                    <input type="range" id="t3t" min="-1" max="1" value="0" step="0.1" oninput="updateSliderValue('t3t'); updateVisualization();">
                                    <div class="tooltip">
                                        <i class="fas fa-info-circle tooltip-icon"></i>
                                        <span class="tooltip-text">Controls the time-like twist parameter for Sub-SKB 3, affecting the formation of closed timelike curves (CTCs). Balancing time twists across Sub-SKBs is essential for CTC stability.</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="button-group">
                        <button id="reset-btn" onclick="resetControls()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button id="animate-btn" onclick="toggleAnimation()">
                            <i class="fas fa-play" id="animate-icon"></i> <span id="animate-text">Animate</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Button and Modal -->
    <div class="help-button" onclick="toggleHelpModal()">
        <i class="fas fa-question"></i>
    </div>
    
    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>Interactive Guide</h2>
                <span class="close-help" onclick="toggleHelpModal()">&times;</span>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">What is a Spacetime Klein Bottle?</h3>
                <p>A Spacetime Klein Bottle (SKB) is a non-orientable topological surface with no boundary embedded in 4D spacetime with closed timelike curves. In this model, fundamental particles are represented as SKBs, with intrinsic properties like mass and charge emerging from their topology.</p>
                <p>This visualization is based on research papers exploring a novel hypothesis where quarks and baryons can be modeled using topological structures:</p>
                <ul>
                    <li><a href="https://figshare.com/articles/preprint/A_Categorical_Framework_for_Topological_Features_of_Spacetime_Klein_Bottles_in_Particle_Physics/28466279?file=52550969" target="_blank">A Categorical Framework for Topological Features of Spacetime Klein Bottles in Particle Physics</a></li>
                    <li><a href="https://figshare.com/articles/preprint/4D_Spacetime_Klein_Bottles_as_Fundamental_Particle_Models_pdf/28466276?file=52550963" target="_blank">4D Spacetime Klein Bottles as Fundamental Particle Models</a></li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Basic Controls</h3>
                <ul>
                    <li><strong>Merged Mode:</strong> Toggle between viewing individual sub-SKBs or a merged stable SKB.</li>
                    <li><strong>Time Evolution:</strong> Controls the time parameter, changing the shape dynamically.</li>
                    <li><strong>Loop Factor:</strong> Adjusts the number of loops in the structure.</li>
                    <li><strong>Twist Controls:</strong> Modify the twist parameters along the X, Y, and Z axes.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3 class="help-subtitle">Navigation Tips</h3>
                <p>The 3D visualization supports the following interactions:</p>
                <ul>
                    <li><strong>Rotate:</strong> Click and drag to rotate the view.</li>
                    <li><strong>Zoom:</strong> Use the scroll wheel or pinch gesture to zoom in/out.</li>
                    <li><strong>Pan:</strong> Right-click and drag (or two-finger drag) to pan the view.</li>
                    <li><strong>Reset View:</strong> Double-click to reset the camera position.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3>About Topological Properties</h3>
                <p>The SKB visualizer calculates and displays several key topological invariants that characterize the 4D manifold structure, which we represent through wireframe visualizations:</p>
                <ul>
                    <li><strong>Euler Characteristic:</strong> A topological invariant, calculated as V - E + F (vertices - edges + faces). For Klein bottles, this is always 0.</li>
                    <li><strong>Stiefel-Whitney Classes:</strong> Cohomology classes that characterize the twisting of the tangent bundle. The first class (w₁) indicates orientability, while the second class (w₂) is related to the possibility of having a spin structure.</li>
                    <li><strong>Intersection Form:</strong> A bilinear form on the middle-dimensional homology that describes how 2-cycles intersect.</li>
                    <li><strong>Kirby-Siebenmann Invariant:</strong> An obstruction to smoothing a 4-manifold. When non-zero, it indicates exotic smooth structures that may relate to quantum-gravitational effects in the SKB model.</li>
                    <li><strong>Genus:</strong> Roughly corresponds to the number of "holes" in the surface. In SKB theory, this relates to particle generation.</li>
                    <li><strong>Homology Groups:</strong> Algebraic structures that capture the essential topological features. For Klein bottles, H₁ = Z ⊕ Z₂, representing its non-orientability and loop structure.</li>
                    <li><strong>CTC Stability:</strong> Indicates whether the configuration allows for stable closed timelike curves (CTCs). Stability depends on the complementary nature of time twist parameters across sub-SKBs.</li>
                    <li><strong>Compatibility:</strong> Indicates whether the current SKB configuration is compatible with stable hadron formation based on topological constraints and CTC stability.</li>
                </ul>
            </div>
            
            <div class="help-section">
                <h3>Topological Compatibility in the SKB Model</h3>
                <p>The Spacetime Klein Bottle model suggests that stable hadrons form when sub-SKBs combine with compatible topological properties:</p>
                <ul>
                    <li><strong>Orientability:</strong> Stable hadrons tend to form from configurations where the overall 4-manifold is orientable (w₁ = 0).</li>
                    <li><strong>Intersection Form:</strong> The intersection form must be non-trivial, indicating interaction between the sub-components.</li>
                    <li><strong>Kirby-Siebenmann Invariant:</strong> Stable configurations typically have ks = 0, corresponding to smooth structures.</li>
                    <li><strong>Twist Parameters:</strong> The combined twist parameters determine the overall topological structure and compatibility.</li>
                </ul>
                <p>Experiment with different configurations to discover compatible combinations!</p>
            </div>
            
            <div class="help-section">
                <h3>Physical Interpretation</h3>
                <p>In the SKB model of fundamental particles:</p>
                <ul>
                    <li><strong>Sub-SKBs:</strong> Represent quark-like components with distinct topological features</li>
                    <li><strong>Twist Parameters:</strong> May correspond to quantum numbers like charge, spin, or color</li>
                    <li><strong>Loop Factors:</strong> Potentially relate to energy levels and mass</li>
                    <li><strong>Merged SKB:</strong> Represents a composite particle (like a baryon) formed by combining sub-SKBs</li>
                    <li><strong>Time Evolution:</strong> Visualizes how particles evolve through closed timelike curves while maintaining their identity</li>
                </ul>
                <p>This visualization tool allows exploration of how different topological configurations might correspond to different particle states and properties.</p>
            </div>
        </div>
    </div>
    
    <script>
        let animationId = null;
        let isAnimating = false;
        
        // Function to update slider value display
        function updateSliderValue(id) {
            const slider = document.getElementById(id);
            const display = document.getElementById(id + '-value');
            display.textContent = slider.value;
            
            // Highlight the value with animation
            display.classList.remove('highlight');
            void display.offsetWidth; // Trigger reflow to restart animation
            display.classList.add('highlight');
            
            // Update topological properties
            updateTopologicalProperties();
        }
        
        // Function to update the visualization based on current parameters
        function updateVisualization() {
            console.log("Updating visualization...");
            
            // Get parameters from controls
            const params = {
                t: parseFloat(document.getElementById('time').value),
                loop_factor: parseInt(document.getElementById('loop-factor').value),
                loop1: parseInt(document.getElementById('loop1').value),
                loop2: parseInt(document.getElementById('loop2').value),
                loop3: parseInt(document.getElementById('loop3').value),
                t1x: parseInt(document.getElementById('t1x').value),
                t1y: parseInt(document.getElementById('t1y').value),
                t1z: parseInt(document.getElementById('t1z').value),
                t1t: parseFloat(document.getElementById('t1t').value),
                t2x: parseInt(document.getElementById('t2x').value),
                t2y: parseInt(document.getElementById('t2y').value),
                t2z: parseInt(document.getElementById('t2z').value),
                t2t: parseFloat(document.getElementById('t2t').value),
                t3x: parseInt(document.getElementById('t3x').value),
                t3y: parseInt(document.getElementById('t3y').value),
                t3z: parseInt(document.getElementById('t3z').value),
                t3t: parseFloat(document.getElementById('t3t').value),
                merge: document.getElementById('merge-toggle').checked ? 1 : 0,
                colors: {
                    skb1: getComputedStyle(document.documentElement).getPropertyValue('--skb1-color').trim(),
                    skb2: getComputedStyle(document.documentElement).getPropertyValue('--skb2-color').trim(),
                    skb3: getComputedStyle(document.documentElement).getPropertyValue('--skb3-color').trim()
                }
            };
            
            console.log("Fetching visualization with params:", params);
            console.log("Plot container:", document.getElementById('plot'));
            
            fetch('/get_visualization', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(params)
            })
            .then(response => {
                console.log("Received response from server:", response.status);
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error("Server returned error:", data.error);
                    return;
                }
                
                console.log("Visualization data received:", data);
                
                try {
                    const plotDiv = document.getElementById('plot');
                    
                    // Clean up existing plot if it exists
                    if (plotDiv && plotDiv._fullLayout) {
                        Plotly.purge(plotDiv);
                    }
                    
                    const layout = createLayout(params.merge);
                    console.log("Rendering plot with layout:", layout);
                    
                    // Create new plot with a small delay to ensure DOM is ready
                    setTimeout(() => {
                        Plotly.newPlot('plot', data.plot.data, layout, {
                            responsive: true,
                            displayModeBar: true,
                            displaylogo: false
                        }).then(() => {
                            console.log("Plot updated successfully");
                            PlotlyDefaults.updatePlotWithDefaults(plotDiv, layout);
                            updateTopologicalProperties();
                        });
                    }, 100);
                } catch (error) {
                    console.error("Error rendering plot:", error);
                }
            })
            .catch(error => {
                console.error("Error fetching visualization:", error);
            });
        }
        
        // Function to create a custom layout
        function createLayout(isMerged) {
            // Get the plot container dimensions
            const plotContainer = document.getElementById('plot');
            const width = plotContainer.offsetWidth;
            const height = plotContainer.offsetHeight;

            return {
                scene: {
                    aspectmode: 'cube',
                    camera: {
                        eye: { x: 1.9, y: 1.9, z: 1.5 },
                        center: { x: 0, y: 0, z: 0 },
                        up: { x: 0, y: 0, z: 1 }
                    },
                    xaxis: {
                        showspikes: false,
                        showgrid: true,
                        zeroline: false,
                        showline: false,
                        showticklabels: true,
                        title: '',
                        gridcolor: 'rgba(80,80,80,0.2)',
                    },
                    yaxis: {
                        showspikes: false,
                        showgrid: true,
                        zeroline: false,
                        showline: false,
                        showticklabels: true,
                        title: '',
                        gridcolor: 'rgba(80,80,80,0.2)',
                    },
                    zaxis: {
                        showspikes: false,
                        showgrid: true,
                        zeroline: false,
                        showline: false,
                        showticklabels: true,
                        title: '',
                        gridcolor: 'rgba(80,80,80,0.2)',
                    },
                    bgcolor: 'rgba(0,0,0,0)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { l: 0, r: 0, b: 0, t: 0, pad: 0 },
                width: width,
                height: height,
                autosize: true,
                legend: {
                    font: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') },
                    bgcolor: 'rgba(30,30,30,0.7)',
                    bordercolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                    borderwidth: 1,
                    y: 0.99,
                    x: 0.01
                },
                hovermode: false,
                annotations: [{
                    showarrow: false,
                    text: isMerged ? 'Merged SKB' : 'Individual Sub-SKBs',
                    font: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                        size: 12
                    },
                    xref: 'paper',
                    yref: 'paper',
                    x: 0.98,
                    y: 0.02
                }]
            };
        }
        
        // Function to update topological properties based on current state
        function updateTopologicalProperties() {
            const isMerged = document.getElementById('merge-toggle').checked;
            const eulerChar = document.getElementById('euler-characteristic');
            const genus = document.getElementById('genus');
            const homologyGroups = document.getElementById('homology-groups');
            const stiefelWhitney = document.getElementById('stiefel-whitney');
            const intersectionForm = document.getElementById('intersection-form');
            const kirbySiebenmann = document.getElementById('kirby-siebenmann');
            const compatibilityStatus = document.getElementById('compatibility-status');
            
            // Calculate topological properties based on parameters
            const t1x = parseInt(document.getElementById('t1x').value);
            const t1y = parseInt(document.getElementById('t1y').value);
            const t1z = parseInt(document.getElementById('t1z').value);
            const t1t = parseFloat(document.getElementById('t1t').value);
            const t2x = parseInt(document.getElementById('t2x').value);
            const t2y = parseInt(document.getElementById('t2y').value);
            const t2z = parseInt(document.getElementById('t2z').value);
            const t2t = parseFloat(document.getElementById('t2t').value);
            const t3x = parseInt(document.getElementById('t3x').value);
            const t3y = parseInt(document.getElementById('t3y').value);
            const t3z = parseInt(document.getElementById('t3z').value);
            const t3t = parseFloat(document.getElementById('t3t').value);
            const loop1 = parseInt(document.getElementById('loop1').value);
            const loop2 = parseInt(document.getElementById('loop2').value);
            const loop3 = parseInt(document.getElementById('loop3').value);
            
            if (isMerged) {
                // Merged Klein bottle properties
                eulerChar.textContent = "0";
                genus.textContent = "2";
                homologyGroups.textContent = "H₁ = Z ⊕ Z₂";
                
                // 4D manifold topology for merged SKB rendered as wireframe
                const orientable = (t1x + t2y + t3z) % 2 === 0;
                stiefelWhitney.textContent = orientable ? "w₁ = 0, w₂ = 0" : "w₁ = 1, w₂ = " + ((t1y*t2z - t1z*t2y) % 2);
                
                // Intersection form depends on various parameters
                let formType = "";
                const sumTwists = Math.abs(t1x + t2x + t3x) + Math.abs(t1y + t2y + t3y) + Math.abs(t1z + t2z + t3z);
                if (sumTwists < 3) formType = "[ ]"; // Trivial
                else if (sumTwists % 2 === 0) formType = "[ 1 0; 0 -1 ]"; // Indefinite
                else formType = "[ 1 0; 0 1 ]"; // Positive definite
                intersectionForm.textContent = "Q = " + formType;
                
                // Kirby-Siebenmann invariant
                const ks = ((loop1 * loop2 * loop3) % 2);
                kirbySiebenmann.textContent = ks.toString();
                
                // Check for CTC stability - time twists should be complementary (sum near zero)
                const timeSum = Math.abs(t1t + t2t + t3t);
                const stableCTC = timeSum < 0.2; // Sum of time twists should be near zero for stable CTCs
                
                // Determine compatibility based on topological constraints including CTC stability
                const compatible = orientable && sumTwists >= 3 && ks === 0 && stableCTC;
                compatibilityStatus.textContent = compatible ? "Compatible" : "Incompatible";
                
                // Add specific message about CTC stability if that's the issue
                if (!compatible && !stableCTC && orientable && sumTwists >= 3 && ks === 0) {
                    compatibilityStatus.textContent = "Incompatible - Unstable CTCs";
                }
                
                compatibilityStatus.classList.remove("compatible-status", "incompatible-status");
                compatibilityStatus.classList.add(compatible ? "compatible-status" : "incompatible-status");
            } else {
                // Individual sub-SKB properties
                eulerChar.textContent = "0";
                genus.textContent = "1";
                homologyGroups.textContent = "H₁ = Z";
                
                // Individual SKBs have simpler topology
                const orientable = false; // Sub-SKBs are non-orientable (like Möbius strips)
                stiefelWhitney.textContent = "w₁ = 1, w₂ = 0";
                intersectionForm.textContent = "Q = [ ]"; // Trivial for individual components
                kirbySiebenmann.textContent = "0";
                
                // Individual sub-SKBs are not compatible by themselves
                compatibilityStatus.textContent = "Requires Merging";
                compatibilityStatus.classList.remove("compatible-status", "incompatible-status");
                compatibilityStatus.classList.add("neutral-status");
            }
            
            // Animate the property changes
            document.querySelectorAll('.property-value').forEach(el => {
                el.classList.remove('highlight');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('highlight');
            });
        }
        
        // Function to reset all controls
        function resetControls() {
            // Stop animation if running
            if (isAnimating) {
                toggleAnimation();
            }
            
            // Reset all sliders to their default values
            document.getElementById('time').value = 0;
            document.getElementById('loop-factor').value = 1;
            document.getElementById('loop1').value = 1;
            document.getElementById('loop2').value = 1;
            document.getElementById('loop3').value = 1;
            document.getElementById('t1x').value = 0;
            document.getElementById('t1y').value = 0;
            document.getElementById('t1z').value = 0;
            document.getElementById('t1t').value = 0;
            document.getElementById('t2x').value = 0;
            document.getElementById('t2y').value = 0;
            document.getElementById('t2z').value = 0;
            document.getElementById('t2t').value = 0;
            document.getElementById('t3x').value = 0;
            document.getElementById('t3y').value = 0;
            document.getElementById('t3z').value = 0;
            document.getElementById('t3t').value = 0;
            document.getElementById('merge-toggle').checked = false;
            
            // Update all value displays
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                updateSliderValue(slider.id);
            });
            
            // Update visualization
            updateVisualization();
        }
        
        // Function to toggle animation
        function toggleAnimation() {
            const animateBtn = document.getElementById('animate-btn');
            const animateIcon = document.getElementById('animate-icon');
            const animateText = document.getElementById('animate-text');
            const timeSlider = document.getElementById('time');
            
            isAnimating = !isAnimating;
            
            if (isAnimating) {
                animateIcon.className = 'fas fa-pause';
                animateText.textContent = 'Pause';
                
                // Animation function
                const animate = () => {
                    let currentTime = parseFloat(timeSlider.value);
                    currentTime = (currentTime + 0.05) % 6.28;
                    timeSlider.value = currentTime.toFixed(2);
                    updateSliderValue('time');
                    updateVisualization();
                    animationId = requestAnimationFrame(animate);
                };
                
                animationId = requestAnimationFrame(animate);
            } else {
                animateIcon.className = 'fas fa-play';
                animateText.textContent = 'Animate';
                cancelAnimationFrame(animationId);
            }
        }
        
        // Function to toggle help modal
        function toggleHelpModal() {
            const modal = document.getElementById('help-modal');
            if (modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'flex';
            }
        }
        
        // Initialize the visualization when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Plotly is loaded
            if (typeof Plotly === 'undefined') {
                console.error("Plotly library is not loaded! This will prevent visualizations from working.");
                alert("Visualization library (Plotly) failed to load. Please try refreshing the page.");
            } else {
                console.log("Plotly visualization library loaded successfully: v" + Plotly.version);
            }
            
            updateVisualization();
            
            // Set up keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.key === 'h' || e.key === 'H') {
                    toggleHelpModal();
                } else if (e.key === 'r' || e.key === 'R') {
                    resetControls();
                } else if (e.key === ' ') { // Space bar
                    toggleAnimation();
                    e.preventDefault(); // Prevent page scrolling
                }
            });
        });

        // Add a resize observer to handle container size changes
        document.addEventListener('DOMContentLoaded', function() {
            const plotContainer = document.getElementById('plot');
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    if (entry.target === plotContainer && Plotly.hasPlot('plot')) {
                        try {
                            Plotly.relayout('plot', {
                                width: entry.contentRect.width,
                                height: entry.contentRect.height
                            });
                        } catch (error) {
                            console.warn('Error in Plotly relayout during resize:', error);
                        }
                    }
                }
            });
            
            if (plotContainer) {
                resizeObserver.observe(plotContainer);
            }
            
            // Rest of your DOMContentLoaded code...
        });

        // Update the window resize handler
        window.addEventListener('resize', function() {
            const plotContainer = document.getElementById('plot');
            if (plotContainer && Plotly.hasPlot('plot')) {
                try {
                    const layout = createLayout(document.getElementById('merge-toggle').checked);
                    Plotly.relayout('plot', layout);
                } catch (error) {
                    console.warn('Error in Plotly relayout during window resize:', error);
                }
            }
        });
    </script>
    
    <!-- Theory and Mathematics Section -->
    <div class="container">
        <div class="control-card" style="margin-top: 30px; margin-bottom: 30px;">
            <div class="card-header">
                <h3 class="card-title">Theory & Mathematics</h3>
            </div>
            <div style="padding: 15px;">
                <h4>4D Manifolds and Spacetime Klein Bottles</h4>
                <p>
                    4D manifolds represent mathematical structures that locally resemble four-dimensional Euclidean space. In the context of this explorer, we focus on Spacetime Klein Bottles (SKBs), which are four-dimensional topological objects with non-orientable characteristics.
                </p>
                
                <h4>Key Mathematical Concepts</h4>
                <ul style="padding-left: 20px; margin: 15px 0;">
                    <li><strong>Topology and Manifolds:</strong> A manifold is a topological space that locally resembles Euclidean space. 4D manifolds have four dimensions and complex topological properties.</li>
                    <li><strong>Klein Bottles:</strong> Non-orientable surfaces that, when embedded in 4D space, can exist without self-intersection. Unlike their 3D representations which must pass through themselves, 4D Klein bottles can be properly embedded.</li>
                    <li><strong>Stiefel-Whitney Classes (w₁, w₂):</strong> Topological invariants that characterize non-orientability and obstruction to spin structures, respectively.</li>
                    <li><strong>Intersection Form (Q):</strong> A bilinear form on the second homology group of a 4-manifold that encodes how topological cycles intersect.</li>
                    <li><strong>Euler Characteristic (χ):</strong> A topological invariant defined as χ = V - E + F - C, where V, E, F, and C are vertices, edges, faces, and cells of a simplicial decomposition.</li>
                    <li><strong>Kirby-Siebenmann Invariant (ks):</strong> A topological invariant that detects whether a 4-manifold admits a smooth structure.</li>
                </ul>

                <h4>Applications in Theoretical Physics</h4>
                <p>
                    The study of 4D manifolds and specifically SKBs has profound implications for several areas of theoretical physics:
                </p>
                
                <ul style="padding-left: 20px; margin: 15px 0;">
                    <li><strong>Fundamental Particle Models:</strong> SKBs can model elementary particles with their intrinsic properties represented by topological invariants.</li>
                    <li><strong>Closed Timelike Curves (CTCs):</strong> Certain configurations of 4D manifolds allow for the existence of stable CTCs, which are paths through spacetime that return to their starting point in both space and time.</li>
                    <li><strong>Quantum Gravity:</strong> 4D manifolds provide geometric frameworks for reconciling quantum mechanics with general relativity.</li>
                    <li><strong>Unified Field Theory:</strong> Topological features of 4D manifolds may explain the unification of fundamental forces at high energies.</li>
                </ul>
                
                <h4>Historical Context</h4>
                <p>
                    The mathematical exploration of higher-dimensional manifolds has a rich history:
                </p>
                <p>
                    The concept of manifolds was developed in the 19th century by mathematicians like Bernhard Riemann, who introduced Riemannian geometry and laid the groundwork for modern differential geometry. The Klein bottle was discovered by Felix Klein in 1882 as a non-orientable surface with no boundary.
                </p>
                <p>
                    The study of 4-manifolds specifically advanced significantly in the late 20th century with breakthroughs by mathematicians like Michael Freedman, who classified compact simply-connected 4-manifolds, and Simon Donaldson, whose work on gauge theory revolutionized our understanding of smooth 4-manifold topology.
                </p>
                <p>
                    The application of 4D manifold theory to physics gained momentum with Edward Witten's work connecting topology with quantum field theory in the 1980s, leading to significant advances in string theory and quantum gravity. Recent research has explored how 4D manifolds like Spacetime Klein Bottles might serve as fundamental models for particle physics, offering a geometric foundation for understanding the fundamental forces and particles of nature.
                </p>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">4D Manifold Explorer</div>
                <div class="footer-links">
                    <a href="/">Home</a>
                    <a href="/visualization">4D Manifold</a>
                    <a href="/evolution">Evolution</a>
                    <a href="/oscillator">Oscillator</a>
                </div>
            </div>
            <div class="copyright">
                &copy; 2024 4D Manifold Explorer. All rights reserved.
            </div>
        </div>
    </footer>
    
    <!-- Navigation Dropdown JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add active class to parent dropdown if child link is active
            const activeLinks = document.querySelectorAll('.dropdown-menu a.active');
            activeLinks.forEach(link => {
                const parentDropdown = link.closest('.nav-dropdown');
                const dropdownToggle = parentDropdown.querySelector('.dropdown-toggle');
                dropdownToggle.classList.add('active');
            });
            
            // Handle click on dropdown toggle (for mobile)
            const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
            dropdownToggles.forEach(toggle => {
                toggle.addEventListener('click', function(e) {
                    // Only apply this on mobile
                    if (window.innerWidth <= 768) {
                        e.preventDefault();
                        const dropdown = this.closest('.nav-dropdown');
                        const dropdownMenu = dropdown.querySelector('.dropdown-menu');
                        
                        // Close all other menus
                        document.querySelectorAll('.dropdown-menu').forEach(menu => {
                            if (menu !== dropdownMenu) {
                                menu.classList.remove('show');
                            }
                        });
                        
                        // Toggle this menu
                        dropdownMenu.classList.toggle('show');
                    }
                });
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.nav-dropdown')) {
                    document.querySelectorAll('.dropdown-menu').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
        });
    </script>
</body>
</html>